# encoding

### Data Encoding Basics

#### URL encoding

Esta tabla es un gráfico de codificación de caracteres que es útil para explicar qué caracteres son "seguros" y qué caracteres deben ser codificados en URLs.

* http://perishablepress.com/stop-using-unsafe-characters-in-urls/

Some commonly encoded characters are:

|Character | Purporse in URL | Encoding| |'#' | Separate anchors | %23 | |'?' | Separate query string | %3F | |'&' | Separate query elements | %24 | |'%' | Indicates an encoded character | %25 | |'/' | Separate domain and directories | %2F | |'+' | Indicates a space | %2B | |'' | Not recommended | %20 or + |

#### HTML encoding

Documentos transmitidos por vía HTTP puede enviar un charset parameter in the header to specify the character encoding del documento enviado. Este es el HTTP header: **Content-Type**

```
Content-Type:text/html;charset=utf-8
```

Define character encoding using HTTP

```
# PHP > Utiliza la función de encabezado para enviar una cabecera HTTP cruda:
header('Content-Type:text/html;charset=utf-8')

# ASP.Net > Utiliza el objeto de respuesta:
<%Response.charset="utf-8"%>

# JSP > Utiliza la directiva de la página:
<%@ page contentType="text/html; charset=UTF-8"%>
```

```
# La Directiva META:
<meta http-equiv="Content-Type" Content="text/html;charset=utf-8">

# Con HTML5, también es posible escribir:
<meta charset="utf-8">
```

**HTML4 y HTML5 especificaciones sobre caracteres especiales**

http://www.w3.org/TR/1998/REC-html40-19980424/charset.html#h-5.3

http://www.w3.org/TR/html5/single-page.html#character-references

* Named characters references:

→ http://en.wikipedia.org/wiki/List\_of\_XML\_and\_HTML\_character\_entity\_references#Character\_entity\_references\_in\_HTML

Las referencias de los caracteres deben comenzar con un **U+0026** AMPERSAND character **(&)**:

\| Referencia de CHaracter | Regla | Persé carácter codificado| | Entidad nombrada entidad | & + named character references + ;| \&It; | | Numerico Decimal | & + # + + ; | < | | Numerico Hexadecimal | & + #x + + ; | < / < |

Algunas variaciones:

\| Referencia de CHaracter | Variación | Codado character| | Numerico Decimal | No terminator (;) | < | | | Uno o más ceros antes del código | \&#060 / \&#0000060| | Numerico Hexadecimal | No terminator (;) | \&#x3c | | | Uno o más ceros antes del código | \&#0x3c / \&#00003c|

#### Base (36|64) encoding

**Base 36 Encoding Scheme**

Base36 - Es el sistema alfanumérico más compacto, insensible en caso, usando caracteres ASCII. De hecho, el alfabeto de esquemas contiene todos los dígitos \[0-9] y letras latinas \[A-Z]
![[Pasted image 20240311151726.png]]
Se utiliza en muchos escenarios del mundo real

* Reddit utilizado si para identificar tanto publicaciones como comentarios

Algunos servicios de acorte de URL como TinyURL utilizan entero Base36 como identificadores compactos y alfanuméricos.

→ http://tinyurl/ljasd

**PHP**

```php
PHP uses the base_convert() function to convert numbers:

OHPE is Base 10 is <?=base_convert("OHPE",36,10);?>
```

**JavaScript** JavaScript utilizó dos funciones:

```js
(1142690.toString(36)
1142690..toString(36) #encode
parseInt("ohpe",36)   #decode
```

**Base64 Encoding Scheme**

Base64 es uno de los esquemas de codificación binaria a texto más extendidos hasta la fecha. Fue diseñado para permitir que los datos binarios se representaran como texto de cadena ASCII.
![[Pasted image 20240311151755.png]]
* El alfabeto del esquema de codificación Base64 se compone de dígitos \[0-9] y letras latinas, tanto mayúsculas como minúsculas \[a-zA-Z], Para un total de 62 valores. Para completar el conjunto de caracteres a 64 hay los caracteres plus (o) y slash (/).
* Mas sobre: http://en.wikipedia.org/wiki/Base64#Implementations\_and\_history

El algoritmo divide el mensaje en grupos de 6 bits\* y luego convierte cada grupo, con el carácter ASCII respectivo, siguiendo la tabla de conversión.
![[Pasted image 20240311151816.png]]
![[Pasted image 20240311151835.png]]
![[Pasted image 20240311151900.png]]
Thats why the allowed characters are 64 (2 raised to 6th power = 64)

* If the lastest gruop is **null**(000000) el valor de codificación correspondiente es **=**
* If the traiing **null groups** son dos, entonces se codificará como **==**

**PHP** PHP usó funciones de base64.encode y base64.decode basado en la implementación de MIME Base64:

```php
<?=base64_encode('encode this string')?> //encode
<?=base64_decode('ZW5jb2RlIHRoaXMgc3RyaW5n')?> //decode
```

**JavaScript** Muchos navegadores pueden manejar base64 nativamente a través de la función **btoa** y **atob**:

```js
window.btoa('encode this string'); //encode
window.atob('ZW5jb2RlIHRoaXMgc3RyaW5n'); //decode
```

Moreover: https://developer.mozilla.org/en-US/docs/Web/API/Window.btoa

#### Unicode encoding

Unicode alias ISO/IEC 10646 Universal Character Set. Puede exponer aplicaciones web a posibles ataques de seguridad, como filtros de derivación.

* http://www.joelonsoftware.com/articles/Unicode.html
![[Pasted image 20240311151917.png]]
![[Pasted image 20240311151936.png]]

UTF = Unicode Transformation Format:

```
- UTF-8
- UTF-16
- UTF-32
```

#### Homoglyph | Visual Spoofing

En tipografía, un **Homoglyph** es uno o dos o más caracteres, o glifos, con formas que aparecen idénticas o no pueden diferenciarse por una inspección visual rápida. -Wikipedia

```
Homograph - una palabra que se ve igual que otra palabra
Homogliph - un personaje parecido usado para crear homógrafos

Ejemplo:
Visual Sp'oo'fing = U+006F (Latin small letter o)
U+03BF (Greek small letter omicron)
```

<img src="../../.gitbook/assets/image (23).png" alt="" data-size="original">
![[Pasted image 20240311151954.png]]
![[Pasted image 20240311152015.png]]
Moreover Confusables: http://unicode.org/cldr/utility/confusables.jsp

Homoglyph Attack Generator: http://www.irongeek.com/homoglyph-attack-generator.php

Artículo sobre Homoglifo y Punycode atack: http://www.irongeek.com/i.php?page=security/out-of-character-use-of-punycode-and-homoglyph-attacks-to-obfuscate-urls-for-phishing

Ellos pueden bypass anti cross-site scripting and SQL Injection filters;

* Crear nombres de usuario y secuestro de cuentas de Spotify: http://labs.spotify.com/2013/06/18/creative-usernames/

> Hay otras formas en que los caracteres y cadenas pueden ser transformados por procesos de software, como normalización, canonicalización, mejor ajuste, etc
![[Pasted image 20240311152159.png]]
![[Pasted image 20240311152220.png]]
→ Moreover: http://websec.github.io/unicode-security-guide/

### Extra Resources

```
- http://unicode.org/cldr/utility/
- http://codepoints.net/
- http://txtn.us/
- http://www.panix.com/~eli/unicode/convert.cgi
```

#### Multiple (De|En) Codings

* Es común abusar de múltiples codificaciones para eludir las medidas de seguridad

```
URL-Encoding > URL
```

### Filtering Basics

> Una mejor práctica común, pero a menudo recomendada, para proteger las aplicaciones web contra ataques maliciosos es el uso de controles específicos de filtrado de entradas y codificación de salida.

Estos reyes de los controles pueden ir desde listas negras ingenuivas hasta listas blancas experimentadas y muy restrictivas. Qué hay en el mundo real? Estamos en algún lugar en el medio.

* El control se puede implementar en diferentes capas en una aplicación web. Pueden ser representadas como bibliotecas y APIs, o en el mejor de los casos, por organizaciones especiales internas u organizaciones externas, como ESAPI por OWASP.
* https://www.owasp.org/index.php/Category:OWASP\_Enterprise\_Security\_API
* Los controles de seguridad también están dentro de los navegadores más comunes.

Generalmente, estas soluciones caen en el mundo de IDS y IPS, pero FOr Web Applications, las más elegidas son el Web Application Firewall (WAFs)

Una solución de código libre y abierto: http://www.modsecurity.org/

#### Regular Expressions (RE or RegEx)

* Representa la forma oficial utilizada para definir las reglas del filtro. Maestría RegEx es fundamental para entender cómo evitar los filtros porque RE es extremadamente potente.
* Es una secuencia especial de caracteres usados Para describir un patrón de búsqueda.

→ expresión regular = regex

→ patrón empaeddo = match

#### Dos tipos principales

* DFA = http://en.wikipedia.org/wiki/Deterministic\_finite\_automaton
* NFA = http://en.wikipedia.org/wiki/Nondeterministic\_finite\_automaton

\| Motor | Programa | | DFA | awk, egrep, MySQL, Procmail | | NFA | .NET languages, Java, Perl, PHP, Python, Ruby, PCRE library, vi, grep, less, more |

Comparación de los motores de expresión regular: http://en.wikipedia.org/wiki/Comparison\_of\_regular\_expression\_engines

Comparación de sabor de expresión regular: http://www.regular-expressions.info/refflavors.html

**Non-printing characters**:

```
its used to evade bad filters and obfuscate the payload.
```

**Match Unicode Code Point**:

```
Los sabores de expresión regular que funcionan con Unicode utilizan meta-secuencias específicas para que coinádense con puntos de código.
La secuencia is \ucode-point, donde el código-punto es el número hexadecimal del carácter to match. 
Los hay. regex sabores como PCRE que no apoyen la antigua anotación, 
pero utilizar una secuencia alternativa \x{code-point} en su lugar.
```

ejemplo:

```
\u2603   = the snowman character in .NET, Java, Javascript and Python
\x{2603} = the snowman character in Apache and PHP (PCRE library)
```

**Meta-sequence Quality**:

```
\p{quality-id} = tener una calidad específica
\P{quality-id} = no tener calidad
```

**Match Unicode Category**:

```
# Para combinar la cuerda con todas las variaciones de la caja (menor, superior y título), este regex hace el trabajo:
[\p{Ll}\p{Lu}\p{Lt}]

# Como abreviatura, algunos sabores de regex implementan esta solución:
\p{L&}
```

### Web Application Firewal - WAF

ByPass WAFs

```
|-| = en vez de usar esto
|→| = la mejor opción es
```

#### Cross-Site Scripting:

```
- alert('xss') 
- alert(1)
→ prompt('xss') 
→ prompt(8)
→ confirm('xss')
→ confirm(8)
→ alert(/xss/.source)
→ window[/alert/.source](8)

- alert(document.cookie) 
→ with(document)alert(cookie) 
→ alert(document['cookie'])
→ alert(document[/cookie/.source])
→ alert(document[/coo/.source+kie/.source])

- <img src=x onerror=alert(1);>
→ <svg/onload=alert(1)>
→ <video src=x onerror=alert(1);>
→ <audio src=x onerror=alert(1);>

- javascript:alert(document.cookie)
→ data:text/html;base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4=
```

#### Blind SQL Injection

```
- 'or 1=1           '
- 'or 6=6           '
→ 'or 0x47=0x47     '
- or char(32)=''
→ or 6 is not null
```

#### SQL Injection

```
- UNION SELECT
→ UNION ALL SELECT
```

#### Directory Traversal

```
- /etc/passwd
→ /too/../etc/far/../passwd
→ /etc//passwd
→ /etc/ignore/../passwd
→ /etc/passwd........
```

#### Web Shell

```
- c99.php
- r57.php
- shell.aspx
- cmd.jsp
- CmdAsp.asp
→ augh.php
```

### Detection and Fingerprinting

#### Cookie Values

* Citrix Netscaler utiliza algunas cookies diferentes en las respuestas HTTP como **ns\_af** or **citrix\_ns\_id** or **NSC\_**
* F5 BIG-IP ASM (Application Security Manager) usos cookies empezando por **TS** y siguió con una cadena que respeta el siguiente regex:

```
^TS[a-z-A-Z0-9]{3,6}
```

* Barracura utiliza dos cookies **barra\_counter\_session** y **BNI\_\_BARRACUDA\_LB\_COOKIE**

#### Header Rewrite

Algunas WAF reescriben las cabeceras HTTP. Normalmente estos modifican el encabezado del servidor para engañar a los atacantes.

#### HTTP Response Code

Algunos WAF modifican los códigos de respuesta HTTP si la solicitud es hostil; For example:

```
- mod_security       > 406 Not Acceptable
→ AQTRONIX WebKnight > 999 No Hacking
```

#### HTTP Response Body

también es posible detectar en el cuerpo de respuesta

Ejemplo:

\| | | |...Mod\_Security...|...**AQTRONIX WebKnight** ...| | |\</body |

**dotDefender** Bloqueada de tu solicitud

#### Cierra la conexión

es útil para dejar devenir la conexión en el caso de que la WAF detecta una petición maliciosa

* mod\_security

#### Detect WAF

**wafw00f** es una herramienta escrita en pitón que puede detectar hasta 20 productos diferentes de WAF

* wafw00f - https://code.google.com/p/waffit/

Las técnicas utilizadas para detectar una WAF son similares a las que hemos visto anteriormente:

1. Cookies
2. Server Cloaking
3. Response Codes
4. Drop Action
5. Pre-Built-in Rules

* Nmap contiene un script que trata de detectar la presencia de una aplicación web fireall, su tipo y versión. http://nmap.org/nsedoc/scripts/http-waf-fingerprint.html

→ nmap --script=http-waf-fingerprint -p 80

* imperva-detect = https://code.google.com/p/imperva-detect/

### Client-Side Filters

Los navegadores son la principal media utilizada para abordar client-side attacks

#### Browser Add-ons

NoScript Security Suite es una herramienta de seguridad basada en una lista blanca que básicamente desactiva todo el contenido web ejecutable (Javascript, Java, Flash, Silverlight, ...) y permite al usuario elegir qué sitios son **trusted**, permitiendo así el uso de estas tecnologías.

→ https://addons.mozilla.org/en-US/firefox/addon/noscript/

* http://noscript.net/features#xss is effect browser-based solutions to prevent targeted malicious web attacks.

#### XSS Filter (IE)

c:\windows\system32\mshtml.dll library. Ways to inspect:

```bash
# Hex editors like WinHex. Notepad++ with TextFX plugin
# IDAPro
# MS-DOS commands

findstr /C:"sc{r}" \WINDOWS\SYSTEM32\mshtml.dll | find "{"
> savepath //u can save to a file For more readable results
```

#### Neutering in Action

Básicamente, una vez detectada una inyección maliciosa, el filtro XSS modificó la parte malvada de la carga útil añadiendo el carácter "a" en lugar del chracter neutro, definido en las reglas.

```
evil > ev{i}l > ev#l
<svg/onload=alert(1)> = <svg/#nload=alert(1)>
```

Los sitios web que optaron por optar por no participar de esta protección pueden utilizar la cabecera de respuesta HTTP:

```
X-XSS-Protection: 0
X-XSS-Protection: 1; mode=block //instead of sanitize the page, will render a simple #
# others browsers like safari, used the same scheme
```

#### XSS Auditor - WebKit/Blink

* http://www.adambarth.com/papers/2010/bates-barth-jackson.pdf
* enabled by default in browsers such as: chrome, opera and safari

THe filter analiza tanto las solicitudes entrante como la salida. Si, en los datos analizados de HTML, encuentra código ejecutable dentro de la respuesta, entonces detiene el script y genera una alerta de consola similar a la siguiente. **The XSS Auditor refused to execute a script in ...**

> Sin embargo, hay muchos bypasss también
