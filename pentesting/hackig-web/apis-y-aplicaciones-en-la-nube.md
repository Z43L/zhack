# APIs y aplicaciones en la nube

* Introducción a las APIs
* Pruebas y ataques de API
* Control de acceso a la API
* Intercambio de recursos
* Atacar aplicaciones basadas en la nube

### Introducción a las APIs <a href="#introduction-to-apis" id="introduction-to-apis"></a>

API = Interfaz de programación de aplicaciones

* Es una colección de puntos finales sin GUI en una forma estandarizada, por lo que puede ser utilizada tanto por un usuario humano como por una máquina. A menudo va acompañado de documentación que puede estar tanto en una máquina como en un formato legible por humanos

Hay muchas APIs, por ejemplo:

```
- Windows API
- Remote APIs (RPC  - remote procedure call)
- Web APIs 
# Web services (SOAP/XML)
# REST APIs (JSON) 
```

Las API difieren de un sitio web porque:

```
- It has a standardized input/output form so that it can be scripted
- Its language independent (it should work on each platform in the same way)
- It aims to be secure (e.g. it allows only some predefined methods)
```

Las API SOAP utilizan el protocolo simple de acceso a objetos para definir el estándar de comunicación, de modo que se pueda pasar en ellas el aspecto de la solicitud y la respuesta, así como los parámetros.

Los mensajes SOAP (solicitudes HTTP) son un tipo XML y deben contener algunos elementos especiales

```
- Content type text/xml is also allowed
- SOAPAction is sometimes used just For the standard and sometimes needs to hold the called method name
```

![[Pasted image 20240311160904.png]]![[Pasted image 20240311160915.png]]
API Contiene documentación legible tanto por humanos como por máquinas. En el caso de las API basadas en SOAP, la documentación se almacena en archivos WSDL. Normalmente, estos archivos se almacenan en la vía de acceso **?wsdl**

→ https://api.example.com/api/?wsdl

Eche un vistazo a un servicio de calculadora en línea de ejemplo:

→ http://www.dneonline.com/calculator.asmx

En la siguiente dirección:

```
→ http://www.dneonline.com/calculator.asmx?op=Add
# u can see an examplary SOAP request that was issued in order to speak to the calculator service

→ http://www.dneonline.com/calculator.asmx?wsdl
# to see the full WSDL
```

Este tipo de interfaz, dotada de documentación que puede ser analizada por una máquina, nos permite exponer un gran número de métodos donde cada uno de ellos tiene su propio propósito.

* Otro tipo de API son las API REST (Transferencia de estado de representación).

Normalmente, el método al que el cliente está a punto de llamar se encuentra en la ruta de acceso del recurso:

```
GET /api/v2/methodName
```

* Dependiendo del tipo de solicitud, los parámetros se pueden pasar de forma diferente

En las API REST, los métodos HTTP tienen un significado especial:

```
GET    - Read   resource
POST   - Create resource
PUT    - Update resource
DELETE - Delete resource
PATCH  - Update resource partially
```

Excepto en el caso de las solicitudes GET, los parámetros de los métodos de API se pasan en el cuerpo de la solicitud

> Recuerde que el significado de estos métodos es una práctica común y no un requisito, por lo que técnicamente es posible que un método que encuentre haga algo diferente (por ejemplo, POST se usa para iniciar sesión)

Un ejemplo de solicitud de API REST:

```
- Path often contains the API version
- Content-type application/json header is required
- Parameters are passed as JSON array
```

A menudo también es posible pasar los parámetros de la API REST como XML, por lo que el equivalente de la solicitud de la diapositiva anterior se vería como la lista de la derecha

La API REST también tiene un estándar de documentación llamado archivo WADL.

```
https://www.w3.org/Submission/wadl/
```

Al igual que WSDL, en breve presentaremos herramientas que ayudan a analizar el archivo largo para no reescribir todos los métodos manualmente.

* Con el fin de facilitar la vida de los desarrolladores (y pentesters), algunas API incluyen una representación de API más amigable para el ser humano. Por ejemplo, un nombre de motor API muy popular, **Swagger**, se encuentra a menudo con su página de demostración, que contiene formularios con descripción y posibilidad de emitir una solicitud a cada método.

Puedes ver un ejemplo de la API de Swagger aquí:

```
https://swagger.io/tools/swagger-ui/
```

#### Recursos <a href="#resources" id="resources"></a>

```
- https://swagger.io/
- https://www.w3.org/TR/wsdl.html
- https://www.w3.org/Submission/wadl/
- https://www.w3.org/TR/soap/
```

### Pruebas y ataques de API <a href="#api-testing-and-attacking" id="api-testing-and-attacking"></a>

Las API están construidas de manera que una ruta de solicitud (un punto final) nos permite llamar a un método (ejecutar un tipo de acción).

* La ruta que estamos solicitando es una asignación abstracta a algunos recursos; esto significa que, al solicitar el punto de conexión /api/v3/methodName, no refleja la estructura de archivos o directorios en el servidor.
* La solicitud es procesada por un componente especial que asigna la ruta de acceso a determinados controladores de operaciones y no a recursos físicos de archivo/directorio
* Sin embargo, no se desanime de usar sus herramientas de descubrimiento de contenido favoritas en el servidor habilitado para API. Algunas rutas de acceso del servidor se pueden asignar a las rutinas de la API, pero aún así, algunas solicitudes pueden ser manejadas por el servidor de una manera original, lo que le permite exponer archivos y directorios al usuario.

Independientemente del hecho de que las API hacen uso de métodos predefinidos, debe tener en cuenta que aún puede haber vulnerabilidades relacionadas con:

```
- Parameters to these predefined functions
- The API parsing itself
- Access to sensitive methods
```

En primer lugar, debes centrarte en el reconocimiento adecuado de la interfaz API:

```
- What is the API name and version?
- Its a custom implementation or a open-source product?
- Is there any online documentation available?
- Are there any interesting methods?
- Does the documentation exist on the target server (?wsdl, ?wadl, or similar)?
- Does the API require authentication, or is publicy available?
- If there is both local and public documentation For an API, do they match?
- Maybe some methods were hidden from local users (typically ones that allow insecure operations)
```

> Recopile tantos puntos de conexión de API como sea posible U también debería poder obtener el archivo WSDL/WADL para realizar más pruebas

* La reconstrucción de las llamadas a la API a partir de un archivo WSDL/WADL sin procesar llevaría mucho tiempo, por lo que una herramienta adecuada podría ayudarle a hacerlo más rápido.
* Para probar la API y analizar archivos WSDL/WADL en un conjunto de métodos listos para usar, es posible que desee usar **Postman**, la edición gratuita de **SOAPUI** o la extensión Burp PRO llamada **WSDLer**

#### SOAPUI <a href="#soapui" id="soapui"></a>

→ https://www.soapui.org/downloads/latest-release.html

SoapUI se puede iniciar desde su ubicación predeterminada

```
/usr/local/bin/SoapUI-5.5.0
locate SoapUI
```

Primero conéctalo al proxy, en este caso, la instancia de Burpsuite. De esta manera, podrá reproducir y cambiar las solicitudes emitidas a la API. Para configurar el proxy, debe ir a Archivo

```
  -> Preferences -> Proxy Settings and point it to BURP instance
```
![[Pasted image 20240311160934.png]]
> A continuación, puede activar y desactivar el proxy haciendo clic en el botón Proxy en el menú superior.

* Intentemos ahora analizar el archivo WSDL/WADL de ejemplo. Hay archivos de muestra que se envían con el propio software
* Para cargar un WSDL (para SOAP) o WADL (para REST), haga clic en los botones respectivos en la interfaz de usuario de Soap en el menú superior.

> De forma predeterminada, puede encontrar archivos WSDL/WADL de ejemplo en /root/SoapUI-Tutorials/WSDL-WADL/

* si ahora hace clic en un nodo de árbol y luego hace doble clic en **Solicitar**, aparecerá una ventana de solicitud. En este caso, estamos viendo el método de **inicio de sesión**.
![[Pasted image 20240311160942.png]]
El método también se puede encontrar en el archivo WSDL. SoapUI rellena automáticamente los marcadores de posición de argumentos con **?**. Es usted quien debe decidir qué rellenar allí.

* En ese caso, vemos que la aplicación espera el argumento de tipo **String**
* si presiona el botón verde, se emitirá la solicitud y, en este caso, se redirigirá a través de Burp Suite.
![[Pasted image 20240311160955.png]]
#### REPOSO <a href="#rest" id="rest"></a>

Las pruebas de las API REST se pueden hacer exactamente de la misma manera; La diferencia es que importa un archivo WADL en lugar de WSDL

*   Por lo tanto, una vez que encuentre un WSDL en la aplicación web, puede copiar su código fuente

    ```
    (Open it in a Browser, go to Source, and select all -> copy & past to a file) and import it to SoapUI
    ```
* La API es otro mecanismo de transporte Para obtener información que se envía al consumidor de la API (back-end de la aplicación)
* Con esto en mente, puede intentar manipular todo lo que transporta la API: por ejemplo, en caso de una solicitud similar a la presentada anteriormente, puede verificar si el campo de nombre de usuario o contraseñas es vulnerable a ataques de inyección
![[Pasted image 20240311161006.png]]